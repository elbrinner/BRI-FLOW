<template id="tpl-help-modal">
  <!-- Modal de Ayuda (como <dialog> accesible) -->
  <dialog id="helpModal" class="w-full max-w-3xl p-0">
    <!-- Contenedor principal: altura limitada al viewport, sin overflow oculto para no bloquear el scroll interno -->
    <div class="bg-white flex flex-col rounded-lg shadow-lg" style="display:flex;flex-direction:column;height:80vh;max-height:80vh;">
      <!-- Cabecera -->
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-lg font-semibold">Ayuda rápida — Contar elementos y expresiones</h3>
        <button id="helpModalClose" class="text-gray-600 hover:text-gray-900">✕</button>
      </div>
      <!-- Cuerpo scrollable -->
      <div id="helpModalBody" class="p-4 space-y-4 text-sm" style="overflow-y:auto;max-height:calc(80vh - 56px);scroll-behavior:smooth;-webkit-overflow-scrolling:touch;">
        <!-- Índice -->
        <div class="p-3 bg-white rounded border" id="indice">
          <h4 class="font-semibold mb-2">Índice</h4>
          <ul class="list-disc pl-6 space-y-1">
            <li><a href="#expresiones" class="text-sky-700 hover:underline">Expresiones y operadores</a></li>
            <li><a href="#funciones" class="text-sky-700 hover:underline">Funciones disponibles</a></li>
            <li><a href="#rutas" class="text-sky-700 hover:underline">Rutas a propiedades y listas</a></li>
            <li><a href="#nulos" class="text-sky-700 hover:underline">Nulos y vacíos</a></li>
            <li><a href="#uso" class="text-sky-700 hover:underline">Uso por contexto</a></li>
            <li><a href="#if" class="text-sky-700 hover:underline">Ejemplos rápidos de IF</a></li>
            <li><a href="#tipos" class="text-sky-700 hover:underline">Tipos de nodo soportados</a></li>
            <li><a href="#ejemplos" class="text-sky-700 hover:underline">Ejemplos por tipo</a>
              <ul class="list-disc pl-6 mt-1 space-y-1">
                <li>
                  <a href="#agent_call" class="text-sky-700 hover:underline">Agent Call</a>
                  <ul class="list-disc pl-6 mt-1 space-y-1">
                    <li><a href="#agent_profiles_table" class="text-sky-700 hover:underline">Perfiles (tabla)</a></li>
                    <li><a href="#agent_options" class="text-sky-700 hover:underline">Opciones del agente</a></li>
                    <li><a href="#agent_common_errors" class="text-sky-700 hover:underline">Errores comunes</a></li>
                  </ul>
                </li>
                <li><a href="#rest_call" class="text-sky-700 hover:underline">REST Call</a></li>
                <li><a href="#multi_button" class="text-sky-700 hover:underline">Multi Button</a></li>
                <li><a href="#flow_jump_return" class="text-sky-700 hover:underline">Flow Jump / Return</a></li>
                <li><a href="#debug_node" class="text-sky-700 hover:underline">Debug</a></li>
              </ul>
            </li>
          </ul>
        </div>

        <!-- Expresiones y operadores -->
        <div class="p-3 bg-white rounded border" id="expresiones">
          <p class="mb-2">Puedes contar elementos de una lista usando <code class="bg-gray-100 px-1 rounded">len(nombre_lista)</code>. Las expresiones se evalúan en condiciones, asignaciones y plantillas <code class="bg-gray-100 px-1 rounded">{{ ... }}</code>.</p>
          <h4 class="font-semibold mb-2">Operadores soportados</h4>
          <ul class="list-disc pl-6 space-y-1">
            <li>
              Comparación (backend IF):
              <code class="bg-gray-100 px-1 rounded">==</code>,
              <code class="bg-gray-100 px-1 rounded">!=</code>,
              <code class="bg-gray-100 px-1 rounded">&gt;</code>,
              <code class="bg-gray-100 px-1 rounded">&lt;</code>,
              <code class="bg-gray-100 px-1 rounded">&gt;=</code>,
              <code class="bg-gray-100 px-1 rounded">&lt;=</code>
            </li>
            <li>
              Lógicos (backend IF):
              <code class="bg-gray-100 px-1 rounded">&&</code>,
              <code class="bg-gray-100 px-1 rounded">||</code>,
              <code class="bg-gray-100 px-1 rounded">!</code>
              <span class="text-xs text-gray-500">(sin paréntesis/precedencia avanzada)</span>
            </li>
            <li class="text-gray-700">
              Aritméticos y ternario en editor:
              <code class="bg-gray-100 px-1 rounded">+</code>,
              <code class="bg-gray-100 px-1 rounded">-</code>,
              <code class="bg-gray-100 px-1 rounded">*</code>,
              <code class="bg-gray-100 px-1 rounded">/</code>,
              <code class="bg-gray-100 px-1 rounded">cond ? a : b</code>
              <span class="text-xs text-gray-500">(útiles en plantillas/preview; no evaluados por el IF del backend)</span>
            </li>
          </ul>
          <pre class="bg-gray-100 p-2 rounded text-xs mt-2">len(items) &gt; 0 &amp;&amp; startsWith(name, 'A')</pre>
        </div>

        <!-- Funciones -->
        <div class="p-3 bg-white rounded border" id="funciones">
          <h4 class="font-semibold mb-2">Funciones disponibles (con ejemplos)</h4>
          <ul class="list-disc pl-6 space-y-1">
            <li><b>len(x)</b> (backend) → <i>number</i>: longitud de string o lista — <code class="bg-gray-100 px-1 rounded">len(items)</code></li>
            <li><b>split(text, 'sep')</b> (backend) → <i>list&lt;string&gt;</i>: string→lista — <code class="bg-gray-100 px-1 rounded">split('a,b,c', ',')</code></li>
            <li><b>join(list, 'sep')</b> (backend) → <i>string</i>: lista→string — <code class="bg-gray-100 px-1 rounded">join(items, ';')</code></li>
            <li><b>addItem(list, value[, index])</b> (backend) → <i>list&lt;any&gt;</i>: nueva lista con el elemento agregado (al final o en <code>index</code>) —
              <code class="bg-gray-100 px-1 rounded">addItem(items, 'x')</code>, <code class="bg-gray-100 px-1 rounded">addItem(items, 'x', 1)</code>
            </li>
            <li><b>removeItem(list, value)</b> (backend) → <i>list&lt;any&gt;</i>: nueva lista quitando la primera coincidencia (comparación laxa numérica/str) —
              <code class="bg-gray-100 px-1 rounded">removeItem(items, 'b')</code>
            </li>
            <li><b>removeAt(list, index)</b> (backend) → <i>list&lt;any&gt;</i>: nueva lista sin el elemento en la posición indicada —
              <code class="bg-gray-100 px-1 rounded">removeAt(items, 0)</code>
            </li>
            <li><b>toNumber(x)</b> (backend) → <i>number</i>: convierte a número — <code class="bg-gray-100 px-1 rounded">toNumber('42')</code></li>
            <li><b>trim(s)</b> (backend) → <i>string</i>: recorta espacios — <code class="bg-gray-100 px-1 rounded">trim(' hola ')</code></li>
            <li><b>upper(x)</b>, <b>lower(x)</b> (backend) → <i>string</i> — <code class="bg-gray-100 px-1 rounded">upper(name)</code></li>
            <li><b>contains(hay, needle)</b> (backend) → <i>boolean</i> — <code class="bg-gray-100 px-1 rounded">contains(name, 'ana')</code></li>
            <li><b>startsWith(s, pref)</b>, <b>endsWith(s, suf)</b> (backend) → <i>boolean</i> — <code class="bg-gray-100 px-1 rounded">startsWith(code,'ES-')</code></li>
            <li><b>isEmpty(x)</b> (backend) → <i>boolean</i>: vacío/null — <code class="bg-gray-100 px-1 rounded">isEmpty(email)</code></li>
            <li><b>coalesce(a,b,c,...)</b> (backend) → <i>any</i>: primer valor no vacío (retorna el primer argumento con valor; tipo según el argumento elegido) — <code class="bg-gray-100 px-1 rounded">coalesce(alias, name, 'N/A')</code></li>
            <li><b>isNull(x)</b>, <b>isNotNull(x)</b> (backend) → <i>boolean</i> — <code class="bg-gray-100 px-1 rounded">isNotNull(user_id)</code></li>
            <li><b>isDefined(x)</b>, <b>isUndefined(x)</b> (backend) → <i>boolean</i> — <code class="bg-gray-100 px-1 rounded">isDefined(resp.data)</code></li>
            <li class="text-gray-700"><b>parseInt(x)</b> (editor) → <i>number</i>. <span class="text-xs text-gray-500">Útil en el editor; el IF backend no la evalúa.</span></li>
            <li class="text-gray-700"><b>parseFloat(x)</b> (editor) → <i>number</i>. <span class="text-xs text-gray-500">Útil en el editor; el IF backend no la evalúa.</span></li>
            <li class="text-gray-700"><b>bool(x)</b> (editor) → <i>boolean</i>. <span class="text-xs text-gray-500">Útil en el editor; el IF backend no la evalúa.</span></li>
          </ul>
          <div class="mt-2">
            <div class="text-xs font-semibold mb-1">Composición:</div>
            <pre class="bg-gray-100 p-2 rounded text-xs">len(split('a,b,c', ','))             // 3
join(split('x|y|z','|'), ', ')       // "x, y, z"
coalesce(trim(nickname), name, 'invitado')

// Listas
items = addItem(items, 'nuevo')       // agrega al final
items = addItem(items, 'X', 1)        // inserta en índice 1
items = removeItem(items, 'b')        // quita primera coincidencia
items = removeAt(items, 0)            // quita el primer elemento</pre>
          </div>
        </div>

        <!-- Rutas -->
        <div class="p-3 bg-white rounded border" id="rutas">
          <h4 class="font-semibold mb-2">Rutas a propiedades y listas</h4>
          <ul class="list-disc pl-6 space-y-1">
            <li>Propiedad anidada: <code class="bg-gray-100 px-1 rounded">user.name</code>, <code class="bg-gray-100 px-1 rounded">resp.data.title</code></li>
            <li>Índice de lista: <code class="bg-gray-100 px-1 rounded">items[0]</code>, <code class="bg-gray-100 px-1 rounded">resp.data.items[0].id</code></li>
            <li>Acceso dentro de loop: <code class="bg-gray-100 px-1 rounded">item</code>, <code class="bg-gray-100 px-1 rounded">index</code></li>
          </ul>
          <div class="mt-2">
            <div class="text-xs font-semibold mb-1">Atajos útiles:</div>
            <ul class="list-disc pl-6 space-y-2 text-xs">
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">coalesce(trim(user.nickname), user.name, 'invitado')</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="coalesce(trim(user.nickname), user.name, 'invitado')">Copiar</button>
              </li>
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">len(items)</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="len(items)">Copiar</button>
              </li>
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">join(items, ', ')</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="join(items, ', ')">Copiar</button>
              </li>
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">contains(lower(user.name), 'ana')</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="contains(lower(user.name), 'ana')">Copiar</button>
              </li>
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">isDefined(resp.data) &amp;&amp; !isEmpty(resp.data)</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="isDefined(resp.data) && !isEmpty(resp.data)">Copiar</button>
              </li>
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">addItem(items, 'nuevo')</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="addItem(items, 'nuevo')">Copiar</button>
              </li>
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">removeItem(items, 'b')</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="removeItem(items, 'b')">Copiar</button>
              </li>
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">removeAt(items, 0)</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="removeAt(items, 0)">Copiar</button>
              </li>
            </ul>
          </div>
        </div>

        <!-- Nulos y vacíos -->
        <div class="p-3 bg-white rounded border" id="nulos">
          <h4 class="font-semibold mb-2">Nulos y vacíos (backend)</h4>
          <ul class="list-disc pl-6 space-y-1">
            <li><code class="bg-gray-100 px-1 rounded">undefined</code> se trata como <code class="bg-gray-100 px-1 rounded">null</code> en el backend.</li>
            <li>¿es nulo o vacío? → <code class="bg-gray-100 px-1 rounded">isEmpty(x)</code></li>
            <li>¿tiene contenido? → <code class="bg-gray-100 px-1 rounded">!isEmpty(x)</code></li>
            <li>¿está definido? → <code class="bg-gray-100 px-1 rounded">isDefined(x)</code></li>
            <li>Equivalencia común: <code class="bg-gray-100 px-1 rounded">x != undefined &amp;&amp; x != null</code> ≈ <code class="bg-gray-100 px-1 rounded">x != null</code></li>
          </ul>
          <pre class="bg-gray-100 p-2 rounded text-xs mt-2">isEmpty(email) || len(items) == 0
isDefined(resp.data) &amp;&amp; !isEmpty(resp.data)</pre>
        </div>

        <!-- Uso por contexto -->
        <div class="p-3 bg-white rounded border" id="uso">
          <h4 class="font-semibold mb-2">Uso por contexto</h4>
          <ul class="list-disc pl-6 space-y-1">
            <li>Condición (backend IF): <code class="bg-gray-100 px-1 rounded">len(items) &gt; 0</code>, <code class="bg-gray-100 px-1 rounded">isEmpty(x)</code></li>
            <li>Asignación (backend): <code class="bg-gray-100 px-1 rounded">x = toNumber('42')</code>, <code class="bg-gray-100 px-1 rounded">y = join(items, ',')</code></li>
            <li>Texto (plantillas): <code class="bg-gray-100 px-1 rounded">Hola {{ upper(user_name) }}</code></li>
            <li>JSON embebido en texto: escapa comillas — <code class="bg-gray-100 px-1 rounded">{"user":"{{ user_name }}"}</code></li>
          </ul>
        </div>

        <!-- IF ejemplos -->
        <div class="p-3 bg-white rounded border" id="if">
          <h4 class="font-semibold mb-2">Ejemplos rápidos de IF (backend)</h4>
          <p class="text-xs text-gray-600 mb-2">Sugerencia: usa nombres de variables sin {{ }}. También funcionan con {{ var }} si lo prefieres.</p>
          <ul class="list-disc pl-6 space-y-2">
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">isEmpty(my_var)</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="isEmpty(my_var)">Copiar</button>
              <span class="text-xs text-gray-500">nulo/vacío</span>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">!isEmpty(my_var)</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="!isEmpty(my_var)">Copiar</button>
              <span class="text-xs text-gray-500">tiene contenido</span>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">isDefined(my_var) &amp;&amp; !isEmpty(my_var)</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="isDefined(my_var) && !isEmpty(my_var)">Copiar</button>
              <span class="text-xs text-gray-500">definido y no vacío</span>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">my_var == null</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="my_var == null">Copiar</button>
              <span class="text-xs text-gray-500">nulo/undefined</span>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">my_var != null</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="my_var != null">Copiar</button>
              <span class="text-xs text-gray-500">tiene algún valor</span>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">len(items) &gt; 0</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="len(items) > 0">Copiar</button>
              <span class="text-xs text-gray-500">lista no vacía</span>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">contains(name, 'ana')</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="contains(name, 'ana')">Copiar</button>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">startsWith(code, 'ES-')</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="startsWith(code, 'ES-')">Copiar</button>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">coalesce(alias, name, 'N/A') != 'N/A'</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="coalesce(alias, name, 'N/A') != 'N/A'">Copiar</button>
              <span class="text-xs text-gray-500">alguno de alias/name presente</span>
            </li>
          </ul>
        </div>

        <!-- Tipos de nodo -->
        <div class="p-3 bg-white rounded border" id="tipos">
          <h4 class="font-semibold mb-2">Tipos de nodo soportados (motor backend)</h4>
          <ul class="list-disc pl-6 space-y-1">
            <li><b>start</b>: declara variables iniciales</li>
            <li><b>response</b>: muestra texto con {{ vars }}</li>
            <li><b>input</b>: guarda entrada del usuario</li>
            <li><b>choice</b>: opciones; o modo switch por casos</li>
            <li><b>button</b> / <b>multi_button</b>: botones estáticos o dinámicos</li>
            <li><b>assign_var</b>: asigna valores con funciones (len, split, join, toNumber, trim, upper/lower, contains, startsWith/endsWith, isEmpty, coalesce)</li>
            <li><b>rest_call</b>: llamadas HTTP con mapeos</li>
            <li><b>agent_call</b>: invoca un agente (normal/RAG) y puede streamear o guardar en variable</li>
            <li><b>condition (if)</b>: evalúa expresión booleana</li>
            <li><b>loop</b>: foreach / while con <code>item</code> e <code>index</code></li>
            <li><b>set_goto</b>: redirige el siguiente salto por variable</li>
            <li><b>flow_jump / flow_return</b>: cambia de flujo y retorna</li>
            <li><b>end</b>: finaliza el flujo</li>
            <li><b>debug</b>: log rápido, útil para diagnóstico</li>
          </ul>
        </div>

        <!-- Insertar ejemplo -->
        <div class="p-3 bg-gray-50 rounded border">
          <div class="font-semibold mb-1">Insertar ejemplo en el canvas</div>
          <p class="mb-2">Crea un flujo mínimo con variables, conteo, join y toNumber:</p>
          <ol class="list-decimal pl-6 space-y-1 mb-3">
            <li>Start → define variable <code>items</code> como lista</li>
            <li>Assign: <code>items = split('a,b,c', ',')</code></li>
            <li>Assign: <code>items_count = len(items)</code></li>
            <li>Assign: <code>csv = join(items, ';')</code></li>
            <li>Assign: <code>n = toNumber('42')</code></li>
            <li>Response: <code>Tienes {{ items_count }} elementos; csv={{ csv }}; n={{ n }}</code></li>
            <li>End: finaliza el flujo</li>
          </ol>
          <button id="btnInsertExample" class="px-3 py-2 bg-sky-600 text-white rounded text-sm">Insertar ejemplo</button>
        </div>

        <hr class="my-2"/>
        <!-- Ayuda del simulador -->
        <div>
          <h4 class="text-base font-semibold">Ayuda del Simulador (resumen)</h4>
          <div class="mt-2 space-y-3">
            <div>
              <h5 class="font-semibold text-sky-600">📝 Variables</h5>
              <p>Interpolación en textos con <code class="bg-gray-100 px-1 rounded">{{variable}}</code>:</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">Hola {{user_name}}, tienes {{user_age}} años</pre>
            </div>
            <div>
              <h5 class="font-semibold text-sky-600">🎨 Markdown</h5>
              <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                <li><code>**negrita**</code>, <code>*cursiva*</code>, <code># Título</code>, listas y <code>`código`</code></li>
              </ul>
            </div>
            <div>
              <h5 class="font-semibold text-sky-600">📊 DataInfo</h5>
              <p>Permite construir JSON con variables interpoladas:</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">{"user":"{{user_name}}","age":{{user_age}}}</pre>
            </div>
            <div>
              <h5 class="font-semibold text-sky-600">💡 Consejos</h5>
              <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                <li>Las variables y Markdown se renderizan en el chat del simulador</li>
                <li>Escapa comillas en JSON cuando sea necesario</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Ejemplos por tipo -->
        <div id="ejemplos">
          <h4 class="text-base font-semibold">Ejemplos por tipo de elemento</h4>
          <div class="mt-2">
            <details class="mb-2"><summary class="font-semibold">Start</summary>
              <p class="text-xs mt-1">Declara variables iniciales del flujo.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">variables: [
  { "name": "items", "isList": true, "defaultValue": "[]" },
  { "name": "user_name", "defaultValue": "" }
]</pre>
            </details>
            <details class="mb-2"><summary class="font-semibold">Response</summary>
              <p class="text-xs mt-1">Muestra texto (array de strings). Soporta Markdown y {{ vars }}.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">i18n: { es: { text: [
  "Hola {{ user_name }}", "Tienes {{ len(items) }} elementos"
]}}</pre>
            </details>
            <details class="mb-2"><summary class="font-semibold">Input</summary>
              <p class="text-xs mt-1">Pide un valor y lo guarda en una variable.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">i18n: { es: { prompt: "Tu nombre" } },
save_as: "user_name"</pre>
            </details>
            <details class="mb-2"><summary class="font-semibold">Assign Variable</summary>
              <p class="text-xs mt-1">Asigna valores (expresiones soportadas: len, split, join, toNumber, bool...).</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">assignments: [
  { "target": "items", "value": "split('a,b,c', ',')" },
  { "target": "items_count", "value": "len(items)" },
  { "target": "csv", "value": "join(items, ';')" },
  { "target": "n", "value": "toNumber('42')" },
  { "target": "user.name", "value": "'Ana'" }
]</pre>
            </details>
            <details class="mb-2"><summary class="font-semibold">Condition</summary>
              <p class="text-xs mt-1">Evalúa una expresión booleana y redirige por true/false.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">expr: "len(items) &gt; 0",
true_target: { node_id: "res_ok" },
false_target: { node_id: "res_vacio" }</pre>
            </details>
            <details class="mb-2"><summary class="font-semibold">ForEach</summary>
              <p class="text-xs mt-1">Itera una lista y expone <code>item</code> y <code>index</code>.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">type: "foreach",
source_list: "items",
item_var: "item",
index_var: "index",
loop_body: { node_id: "resp_item" }</pre>
            </details>
            <details class="mb-2"><summary class="font-semibold">Button/Choice</summary>
              <p class="text-xs mt-1">Ofrece opciones; cada opción apunta a un siguiente nodo.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">options: [
  { "label": "Sí", "target": { "node_id": "n_ok" } },
  { "label": "No", "target": { "node_id": "n_ko" } }
]</pre>
            </details>
            <details class="mb-2" id="rest_call"><summary class="font-semibold">REST Call</summary>
              <p class="text-xs mt-1">Realiza llamadas HTTP. Soporta {{variables}} en la URL.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">method: "GET",
url: "https://api.example.com/user/{{ user_id }}",
save_as: "resp"</pre>
            </details>
            <details class="mb-2" id="agent_call"><summary class="font-semibold">Agent Call</summary>
              <p class="text-xs mt-1">Invoca un agente interno. Puede emitir streaming o funcionar en modo no‑stream guardando la respuesta en una variable.</p>
              <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                <li><b>stream=true</b>: se envían chunks de texto como <i>Stream</i>; el último evento trae <code>isFinal=true</code>.</li>
                <li><b>stream=false</b>: no se pinta directamente; se espera la respuesta completa y se guarda en <code>save_as</code>.</li>
              </ul>
              <div class="text-xs mt-2 font-semibold">Campos principales</div>
              <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                <li><code>agent</code> o <code>agent_profile</code>: nombre del perfil de agente a usar (alias soportado por el backend).</li>
                <li><code>message</code>: prompt del usuario (puede interpolar variables).</li>
                <li><code>system_prompt</code>: instrucciones del sistema/rol.</li>
                <li><code>thread_var</code>: variable donde se guarda el id de hilo para mantener contexto conversacional entre nodos.</li>
                <li><code>save_as</code>: variable donde se guarda el resultado cuando <code>stream=false</code>.</li>
                <li><code>stream</code>: <code>true</code> para SSE en vivo; <code>false</code> para ejecución sincronizada sin pintar directo.</li>
              </ul>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">type: "agent_call",
agent: "rag",  // o usa agent_profile: "rag"
message: "{{ agent_message }}",
system_prompt: "Instrucciones del sistema...",
thread_var: "agent_thread_id",
save_as: "agent_result",
stream: false</pre>
              <p class="text-[11px] text-gray-600 mt-1">Sugerencia: con <code>stream:false</code> muestra luego un <b>response</b> que use <code>{{ agent_result.data.text }}</code> u otra propiedad.</p>
              <div class="text-xs mt-2 font-semibold">Perfiles de agente (cuándo usar cada uno)</div>
              <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                <li><b>normal</b>: conversación/razonamiento directo sin recuperación externa. Úsalo para respuestas libres basadas solo en el prompt.</li>
                <li><b>rag</b>: grounding con Azure AI Search y citaciones; requiere configurar índices/búsqueda. Úsalo cuando necesites respuestas con contexto documental.</li>
                <li><b>coordinator</b>: orquesta participantes/herramientas y fusiona respuestas. Úsalo para flujos con múltiples agentes especializados.</li>
                <li><b>retrieval</b>: solo recuperación de contexto desde el índice, sin generar respuesta. Úsalo para preparar contexto que luego pintarás con un <b>response</b>.</li>
                <li><b>domain_expert</b>: experto de dominio con políticas/tono; sin recuperación por defecto. Úsalo cuando quieras respuestas consistentes a un área específica.</li>
              </ul>
              <div id="agent_profiles_table" class="mt-2">
                <table class="w-full text-xs border border-gray-200">
                  <thead>
                    <tr class="bg-gray-50">
                      <th class="text-left p-2 border-b">Perfil</th>
                      <th class="text-left p-2 border-b">Qué hace</th>
                      <th class="text-left p-2 border-b">Cuándo usar</th>
                      <th class="text-left p-2 border-b">Requisitos/Notas</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="p-2 align-top">normal</td>
                      <td class="p-2 align-top">Generación directa sin recuperación externa.</td>
                      <td class="p-2 align-top">Respuestas libres guiadas por <code>system_prompt</code>.</td>
                      <td class="p-2 align-top">Ignora <code>search</code>; opcional configurar <code>model</code>.</td>
                    </tr>
                    <tr class="bg-gray-50/50">
                      <td class="p-2 align-top">rag</td>
                      <td class="p-2 align-top">Grounding con Azure AI Search y citaciones.</td>
                      <td class="p-2 align-top">Cuando necesitas evidencias/documentos.</td>
                      <td class="p-2 align-top">Configura <code>search.mode</code>, <code>search.indexes</code>, <code>topK</code> y (si <i>semantic/hybrid</i>) <code>semanticConfiguration</code>.</td>
                    </tr>
                    <tr>
                      <td class="p-2 align-top">coordinator</td>
                      <td class="p-2 align-top">Orquesta subagentes/herramientas y consolida.</td>
                      <td class="p-2 align-top">Composición de varios agentes especializados.</td>
                      <td class="p-2 align-top">Define <code>participants</code> y opcional <code>mode</code> (<i>group_chat|sequential|fanout</i>).</td>
                    </tr>
                    <tr class="bg-gray-50/50">
                      <td class="p-2 align-top">retrieval</td>
                      <td class="p-2 align-top">Recupera contexto, no genera respuesta.</td>
                      <td class="p-2 align-top">Preparar datos que pintarás con un <b>response</b>.</td>
                      <td class="p-2 align-top">Requiere <code>search</code>; usa <code>save_as</code>. <b>No</b> aplica <code>stream</code>.</td>
                    </tr>
                    <tr>
                      <td class="p-2 align-top">domain_expert</td>
                      <td class="p-2 align-top">Experto con políticas/tono predefinidos.</td>
                      <td class="p-2 align-top">Respuestas consistentes en un dominio concreto.</td>
                      <td class="p-2 align-top">Sin RAG por defecto; puedes añadir herramientas.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="text-xs mt-2 font-semibold">Streaming (cómo habilitar y qué esperar)</div>
              <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                <li>Activa/desactiva desde el panel del nodo: “Streaming (SSE)” o establece <code>stream: true|false</code> en el JSON.</li>
                <li><b>stream=true</b>: el chat pinta una sola burbuja que se va actualizando con los chunks; el último evento cierra con <code>isFinal=true</code>.</li>
                <li><b>stream=false</b>: el nodo NO pinta nada; guarda el resultado en <code>save_as</code>. Muestra ese valor con un nodo <b>response</b> posterior, p. ej., <code>{{ agent_result.data.text }}</code>.</li>
              </ul>
              <div id="agent_options" class="text-xs mt-3 font-semibold">Opciones del agente (todas las propiedades)</div>
              <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                <li><code>agent</code> | <code>agent_profile</code> (string): perfil del agente. Valores: <i>normal, rag, coordinator, retrieval, domain_expert</i>.</li>
                <li><code>message</code> (string): prompt del usuario. Admite variables <code>{{ }}</code>.</li>
                <li><code>system_prompt</code> (string): instrucciones/rol del sistema.</li>
                <li><code>thread_var</code> (string): variable para conservar el hilo conversacional.</li>
                <li><code>stream</code> (bool): SSE en vivo si <code>true</code>. Por defecto <code>true</code> salvo que se configure a <code>false</code>.</li>
                <li><code>save_as</code> (string): variable destino para guardar la respuesta (clave con <code>stream:false</code> o en <i>retrieval</i>).</li>
                <li><code>model</code> (obj): configuración del modelo, p. ej.: <code>{ provider, deployment|model, temperature, max_tokens }</code>.</li>
                <li><code>tooling</code> (string[]): herramientas simples activas, p. ej. <code>["ai_search"]</code>.</li>
                <li><code>tools</code> (obj[]): herramientas avanzadas con args, p. ej.: <code>[{ name: "ai_search", args: { topK: 5 } }]</code>.</li>
                <li><code>search</code> (obj): configuración para RAG/retrieval. Campos: <code>mode</code> (<i>keyword|semantic|vector|hybrid</i>), <code>indexes</code> (string[]), <code>topK</code> (número), <code>semanticConfiguration</code> (string).</li>
                <li><code>participants</code> (string[]): participantes para <i>coordinator</i>.</li>
                <li><code>mode</code> (string): estrategia de orquestación en <i>coordinator</i>: <i>group_chat|sequential|fanout</i>.</li>
                <li><code>runtime</code> (obj): límites de ejecución, p. ej.: <code>{ timeout_ms, max_internal_steps, retry_count }</code>.</li>
              </ul>
              <div id="agent_common_errors" class="text-xs mt-3 font-semibold">Errores comunes (y cómo corregirlos)</div>
              <div class="mt-1">
                <div class="font-semibold text-[11px] text-gray-700">Perfil: rag</div>
                <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                  <li>Falta <code>search.indexes</code> o <code>topK</code> → añade índices y un <code>topK</code> &gt; 0.</li>
                  <li>Modo <i>semantic/hybrid</i> sin <code>semanticConfiguration</code> → define el nombre configurado en tu índice.</li>
                  <li>Se esperan citaciones pero no hay resultados → revisa <code>search.mode</code>, <code>queryLanguage</code> del índice y permisos del perfil.</li>
                </ul>
                <pre class="bg-gray-100 p-2 rounded text-xs mt-1">search: { mode: "hybrid", indexes: ["tramites-es"], topK: 5, semanticConfiguration: "semantic-config-es" }</pre>
              </div>
              <div class="mt-2">
                <div class="font-semibold text-[11px] text-gray-700">Perfil: retrieval</div>
                <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                  <li>Se espera que “pinte” en el chat → este perfil no genera respuesta. Usa <code>save_as</code> y pinta con un <b>response</b>.</li>
                  <li>Se activa <code>stream:true</code> esperando SSE → no aplica streaming; usa <code>stream:false</code>.</li>
                  <li>Faltan índices o <code>topK</code> → configura <code>search</code> como en RAG.</li>
                </ul>
                <pre class="bg-gray-100 p-2 rounded text-xs mt-1">stream: false</pre>
              </div>
              <div class="mt-2">
                <div class="font-semibold text-[11px] text-gray-700">Perfil: coordinator</div>
                <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                  <li>Sin <code>participants</code> → define al menos uno (p. ej., <i>domain_expert</i>, <i>retrieval</i>).</li>
                  <li>Configura <code>search</code> aquí esperando RAG → pon la búsqueda en subagentes (p. ej., participante <i>retrieval</i> o <i>rag</i>).</li>
                  <li>Modo inválido → usa <i>group_chat</i>, <i>sequential</i> o <i>fanout</i>.</li>
                </ul>
                <pre class="bg-gray-100 p-2 rounded text-xs mt-1">agent: "coordinator"</pre>
              </div>
              <div class="mt-2">
                <div class="font-semibold text-[11px] text-gray-700">Perfil: normal</div>
                <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                  <li>Se añade <code>search</code> pero no se usa → cambia a <i>rag</i> si necesitas grounding, o elimina <code>search</code>.</li>
                  <li>Respuestas demasiado creativas → reduce <code>model.temperature</code> o fija <code>system_prompt</code> más estricto.</li>
                </ul>
              </div>
              <div class="mt-2">
                <div class="font-semibold text-[11px] text-gray-700">Perfil: domain_expert</div>
                <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                  <li>Se esperan citaciones/documentos → este perfil no hace RAG por defecto; añade herramienta de búsqueda o usa <i>rag</i>.</li>
                  <li>Respuestas fuera de estilo → ajusta <code>system_prompt</code> con políticas/tono del dominio.</li>
                </ul>
              </div>
            </details>
            <details class="mb-2"><summary class="font-semibold">Set Goto</summary>
              <p class="text-xs mt-1">Fija la variable de salto (goto) para redirigir el flujo.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">target: "nodo_destino"</pre>
            </details>
            <details class="mb-2" id="multi_button"><summary class="font-semibold">Multi Button</summary>
              <p class="text-xs mt-1">Permite seleccionar múltiples opciones, con mínimos/máximos.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">type: "multi_button",
options: [
  { "label": "A", "value": "A" },
  { "label": "B", "value": "B" }
],
min_selected: 1,
max_selected: 2</pre>
            </details>
            <details class="mb-2" id="flow_jump_return"><summary class="font-semibold">Flow Jump / Flow Return</summary>
              <p class="text-xs mt-1">Salta a otro flujo y retorna al terminar.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">type: "flow_jump",
target: { flow_id: "subflow", node_id: "start" }

// en el subflujo, al finalizar:
type: "flow_return"</pre>
            </details>
            <details class="mb-2" id="debug_node"><summary class="font-semibold">Debug</summary>
              <p class="text-xs mt-1">Escribe un mensaje/payload para diagnóstico durante la ejecución.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">type: "debug",
message: "Valor de x",
payload: { "x": "{{ x }}" }</pre>
            </details>
            <details class="mb-2"><summary class="font-semibold">Form</summary>
              <p class="text-xs mt-1">Recolecta varios campos en una sola interacción.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">fields: [
  { "name": "email", "label": "Email", "type": "text" },
  { "name": "age", "label": "Edad", "type": "number" }
]</pre>
            </details>
            <details class="mb-2"><summary class="font-semibold">End</summary>
              <p class="text-xs mt-1">Finaliza el flujo. Buenas prácticas: todos los flujos deben terminar en un nodo <code>end</code>.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">type: "end"</pre>
            </details>
          </div>
        </div>
      </div>
    </div>
  </dialog>
</template>

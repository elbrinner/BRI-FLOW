<template id="tpl-help-modal">
  <!-- Modal de Ayuda (como <dialog> accesible) -->
  <dialog id="helpModal" class="w-full max-w-6xl p-0">
    <!-- Contenedor principal: altura limitada al viewport, sin overflow oculto para no bloquear el scroll interno -->
    <div class="bg-white flex flex-col rounded-lg shadow-lg" style="display:flex;flex-direction:column;height:90vh;max-height:90vh;">
      <!-- Cabecera -->
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-xl font-semibold">Ayuda r√°pida ‚Äî Contar elementos y expresiones</h3>
        <button id="helpModalClose" class="text-gray-600 hover:text-gray-900 text-2xl">‚úï</button>
      </div>
      <!-- Cuerpo scrollable -->
      <div id="helpModalBody" class="p-6 space-y-4 text-base" style="overflow-y:auto;max-height:calc(90vh - 64px);scroll-behavior:smooth;-webkit-overflow-scrolling:touch;">
        <!-- √çndice -->
        <div class="p-3 bg-white rounded border" id="indice">
          <h4 class="font-semibold mb-2 text-lg">√çndice</h4>
          <ul class="list-disc pl-6 space-y-1">
            <li><a href="#expresiones" class="text-sky-700 hover:underline">Expresiones y operadores</a></li>
            <li><a href="#funciones" class="text-sky-700 hover:underline">Funciones disponibles</a></li>
            <li><a href="#linq" class="text-sky-700 hover:underline">Funciones tipo LINQ</a></li>
            <li><a href="#rutas" class="text-sky-700 hover:underline">Rutas a propiedades y listas</a></li>
            <li><a href="#nulos" class="text-sky-700 hover:underline">Nulos y vac√≠os</a></li>
            <li><a href="#uso" class="text-sky-700 hover:underline">Uso por contexto</a></li>
            <li><a href="#if" class="text-sky-700 hover:underline">Ejemplos r√°pidos de IF</a></li>
            <li><a href="#tipos" class="text-sky-700 hover:underline">Tipos de nodo soportados</a></li>
            <li><a href="#sim_profiles" class="text-sky-700 hover:underline">üîß Gesti√≥n de Perfiles del Simulador (localStorage)</a></li>
            <li><a href="#ejemplos" class="text-sky-700 hover:underline">Ejemplos por tipo</a></li>
              <ul class="list-disc pl-6 mt-1 space-y-1">
                <li>
                  <a href="#agent_call" class="text-sky-700 hover:underline">Agent Call</a>
                  <ul class="list-disc pl-6 mt-1 space-y-1">
                    <li><a href="#agent_profiles_table" class="text-sky-700 hover:underline">Perfiles (tabla)</a></li>
                    <li><a href="#agent_options" class="text-sky-700 hover:underline">Opciones del agente</a></li>
                    <li><a href="#agent_common_errors" class="text-sky-700 hover:underline">Errores comunes</a></li>
                  </ul>
                </li>
                <li><a href="#rest_call" class="text-sky-700 hover:underline">REST Call</a></li>
                <li><a href="#extra_node" class="text-sky-700 hover:underline">Extra</a></li>
                <li><a href="#multi_button" class="text-sky-700 hover:underline">Multi Button</a></li>
                <li><a href="#flow_jump_return" class="text-sky-700 hover:underline">Flow Jump / Return</a></li>
                <li><a href="#debug_node" class="text-sky-700 hover:underline">Debug</a></li>
              </ul>
            </li>
          </ul>
        </div>
          <!-- LINQ -->
          <div class="p-3 bg-white rounded border" id="linq">
            <h4 class="font-semibold mb-2">Funciones tipo LINQ (listas)</h4>
            <p class="text-sm mb-2">Permiten filtrar, transformar y ordenar listas con expresiones sobre <code class="bg-gray-100 px-1 rounded">item</code> e <code class="bg-gray-100 px-1 rounded">index</code>. √ötiles en <b>assign_var</b> y tambi√©n dentro de plantillas <code class="bg-gray-100 px-1 rounded">{{ ... }}</code> (render del backend).</p>
            <ul class="list-disc pl-6 space-y-1 text-sm">
              <li><b>where(list, 'pred')</b> ‚Üí filtra. Ej.: <code class="bg-gray-100 px-1 rounded">where(users, 'item.age &gt;= 18')</code></li>
              <li><b>select(list, 'expr')</b> ‚Üí proyecta. Ej.: <code class="bg-gray-100 px-1 rounded">select(users, 'item.name')</code></li>
              <li><b>orderBy(list, 'expr')</b>, <b>orderByDesc(list, 'expr')</b> ‚Üí ordena. Ej.: <code class="bg-gray-100 px-1 rounded">orderBy(users, 'item.name')</code></li>
              <li><b>distinct(list[, 'expr'])</b> ‚Üí √∫nicos por valor o clave. Ej.: <code class="bg-gray-100 px-1 rounded">distinct(select(users,'item.id'))</code></li>
              <li><b>take(list, n)</b>, <b>skip(list, n)</b> ‚Üí paginado simple.</li>
              <li><b>count(list)</b>, <b>sum(list[, 'expr'])</b>, <b>avg(list[, 'expr'])</b>, <b>min(list[, 'expr'])</b>, <b>max(list[, 'expr'])</b></li>
              <li><b>first(list[, 'pred'])</b>, <b>last(list[, 'pred'])</b></li>
              <li><b>any(list, 'pred')</b>, <b>all(list, 'pred')</b> ‚Üí cuantificadores booleanos.</li>
              <li><b>groupBy(list, 'keyExpr')</b> ‚Üí agrupa en <i>{ key, items }</i>.</li>
              <li><b>selectMany(list, 'selectorList')</b> ‚Üí concatena sublistas del selector.</li>
              <li><b>flatten(list)</b> ‚Üí aplana 1 nivel de listas anidadas.</li>
              <li><b>reduce(list, init, 'accExpr')</b> ‚Üí acumulador. Ej. recomendado: <code class="bg-gray-100 px-1 rounded">reduce(nums, 0, 'acc + toNumber(item)')</code></li>
              <li><b>union(a, b[, 'keyExpr'])</b>, <b>intersect(a, b[, 'keyExpr'])</b>, <b>except(a, b[, 'keyExpr'])</b> ‚Üí operaciones de conjuntos.</li>
              <li><b>reverse(list)</b>, <b>slice(list, start[, count])</b>, <b>indexOf(list, value)</b>, <b>findIndex(list, 'pred')</b></li>
              <li><b>median(list[, 'expr'])</b>, <b>percentile(list, p[, 'expr'])</b>, <b>mode(list[, 'expr'])</b></li>
              <li><b>keyBy(list, 'keyExpr')</b> ‚Üí diccionario <i>clave ‚Üí item</i> (la √∫ltima coincidencia gana).</li>
            </ul>
            <p class="text-[11px] text-gray-600 mt-1">Extra: el ordenamiento soporta num√©rico/alfab√©tico, <i>ignoreCase</i> y posici√≥n de nulos (<i>nullsFirst/nullsLast</i>). Tambi√©n permite ordenamiento por m√∫ltiples claves (<i>thenBy/thenByDesc</i>).</p>
            <p class="text-[11px] text-gray-600 mt-1">Nota: para sumas num√©ricas con <code class="bg-gray-100 px-1 rounded">+</code>, convierte expl√≠citamente cada elemento con <code class="bg-gray-100 px-1 rounded">toNumber(item)</code> para evitar concatenaci√≥n de strings.</p>
            <div class="mt-2">
              <div class="text-xs font-semibold mb-1">Ejemplos pr√°cticos</div>
              <pre class="bg-gray-100 p-2 rounded text-xs">// Adultos por nombre, separados por coma

        <!-- Expresiones y operadores -->
        <div class="p-3 bg-white rounded border" id="expresiones">
          <p class="mb-2">Puedes contar elementos de una lista usando <code class="bg-gray-100 px-1 rounded">len(nombre_lista)</code>. Las expresiones se eval√∫an en condiciones, asignaciones y plantillas <code class="bg-gray-100 px-1 rounded">{{ ... }}</code>.</p>
          <h4 class="font-semibold mb-2">Operadores soportados</h4>
          <ul class="list-disc pl-6 space-y-1">
            <li>
              Comparaci√≥n (backend IF):
              <code class="bg-gray-100 px-1 rounded">==</code>,
              <code class="bg-gray-100 px-1 rounded">!=</code>,
              <code class="bg-gray-100 px-1 rounded">&gt;</code>,
              <code class="bg-gray-100 px-1 rounded">&lt;</code>,
              <code class="bg-gray-100 px-1 rounded">&gt;=</code>,
              <code class="bg-gray-100 px-1 rounded">&lt;=</code>
            </li>
            <li>
              L√≥gicos (backend IF):
              <code class="bg-gray-100 px-1 rounded">&&</code>,
            </div>
            <div class="mt-2">
              <div class="text-xs font-semibold mb-1">Uso en plantillas (render backend)</div>
              <ul class="list-disc pl-6 space-y-2 text-xs">
                <li class="flex items-center gap-2">
                  <code class="bg-gray-100 px-1 rounded">Adultos: {{ join(select(where(users,'item.age &gt;= 18'),'item.name'), ', ') }}</code>
                  <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="{{ join(select(where(users,'item.age >= 18'),'item.name'), ', ') }}">Copiar</button>
                </li>
                <li class="flex items-center gap-2">
                  <code class="bg-gray-100 px-1 rounded">Roles (agrupados): {{ join(select(groupBy(users,'item.role'), 'item.key'), ', ') }}</code>
                  <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="{{ join(select(groupBy(users,'item.role'), 'item.key'), ', ') }}">Copiar</button>
                </li>
                <li class="flex items-center gap-2">
                  <code class="bg-gray-100 px-1 rounded">Tags (aplanado): {{ join(selectMany(users,'item.tags'), ', ') }}</code>
                  <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="{{ join(selectMany(users,'item.tags'), ', ') }}">Copiar</button>
                </li>
                <li class="flex items-center gap-2">
                  <code class="bg-gray-100 px-1 rounded">Suma: {{ sum(nums) }}</code>
                  <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="{{ sum(nums) }}">Copiar</button>
                </li>
                <li class="flex items-center gap-2">
                  <code class="bg-gray-100 px-1 rounded">Suma (reduce): {{ reduce(nums, 0, 'acc + toNumber(item)') }}</code>
                  <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="{{ reduce(nums, 0, 'acc + toNumber(item)') }}">Copiar</button>
                </li>
                <li class="flex items-center gap-2">
                  <code class="bg-gray-100 px-1 rounded">Top 2: {{ take(orderBy(users,'item.age'), 2) }}</code>
                  <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="{{ take(orderBy(users,'item.age'), 2) }}">Copiar</button>
                </li>
                <li class="flex items-center gap-2">
                  <code class="bg-gray-100 px-1 rounded">Union IDs: {{ join(select(union(users, more_users, 'item.id'), 'item.id'), ', ') }}</code>
                  <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="{{ join(select(union(users, more_users, 'item.id'), 'item.id'), ', ') }}">Copiar</button>
                </li>
                <li class="flex items-center gap-2">
                  <code class="bg-gray-100 px-1 rounded">Mediana edad: {{ median(users, 'toNumber(item.age)') }}</code>
                  <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="{{ median(users, 'toNumber(item.age)') }}">Copiar</button>
                </li>
              </ul>
              <p class="text-[11px] text-gray-600 mt-1">Nota: las expresiones dentro de <code>{{ ... }}</code> se eval√∫an en el backend (incluye funciones LINQ).</p>
            </div>
            <div class="mt-2">
              <div class="text-xs font-semibold mb-1">Botones din√°micos (provider)</div>
              <p class="text-xs text-gray-700">Genera opciones desde una lista con filtro/orden y plantillas de etiqueta/valor:</p>
              <pre class="bg-gray-100 p-2 rounded text-xs">type: "button",
              <code class="bg-gray-100 px-1 rounded">||</code>,
              <code class="bg-gray-100 px-1 rounded">!</code>
              <span class="text-xs text-gray-500">(sin par√©ntesis/precedencia avanzada)</span>
            </li>
            <li class="text-gray-700">
              Aritm√©ticos y ternario en editor:
              <code class="bg-gray-100 px-1 rounded">+</code>,
              <code class="bg-gray-100 px-1 rounded">-</code>,
            </div>
          </div>

              <code class="bg-gray-100 px-1 rounded">*</code>,
              <code class="bg-gray-100 px-1 rounded">/</code>,
              <code class="bg-gray-100 px-1 rounded">cond ? a : b</code>
              <span class="text-xs text-gray-500">(√∫tiles en plantillas/preview; no evaluados por el IF del backend)</span>
            </li>
          </ul>
          <pre class="bg-gray-100 p-2 rounded text-xs mt-2">len(items) &gt; 0 &amp;&amp; startsWith(name, 'A')</pre>
        </div>

        <!-- Funciones -->
        <div class="p-3 bg-white rounded border" id="funciones">
          <h4 class="font-semibold mb-2">Funciones disponibles (con ejemplos)</h4>
          <ul class="list-disc pl-6 space-y-1">
            <li><b>len(x)</b> (backend) ‚Üí <i>number</i>: longitud de string o lista ‚Äî <code class="bg-gray-100 px-1 rounded">len(items)</code></li>
            <li><b>split(text, 'sep')</b> (backend) ‚Üí <i>list&lt;string&gt;</i>: string‚Üílista ‚Äî <code class="bg-gray-100 px-1 rounded">split('a,b,c', ',')</code></li>
            <li><b>join(list, 'sep')</b> (backend) ‚Üí <i>string</i>: lista‚Üístring ‚Äî <code class="bg-gray-100 px-1 rounded">join(items, ';')</code></li>
            <li><b>addItem(list, value[, index])</b> (backend) ‚Üí <i>list&lt;any&gt;</i>: nueva lista con el elemento agregado (al final o en <code>index</code>) ‚Äî
              <code class="bg-gray-100 px-1 rounded">addItem(items, 'x')</code>, <code class="bg-gray-100 px-1 rounded">addItem(items, 'x', 1)</code>
            </li>
            <li><b>removeItem(list, value)</b> (backend) ‚Üí <i>list&lt;any&gt;</i>: nueva lista quitando la primera coincidencia (comparaci√≥n laxa num√©rica/str) ‚Äî
              <code class="bg-gray-100 px-1 rounded">removeItem(items, 'b')</code>
            </li>
            <li><b>removeAt(list, index)</b> (backend) ‚Üí <i>list&lt;any&gt;</i>: nueva lista sin el elemento en la posici√≥n indicada ‚Äî
              <code class="bg-gray-100 px-1 rounded">removeAt(items, 0)</code>
            </li>
            <li><b>toNumber(x)</b> (backend) ‚Üí <i>number</i>: convierte a n√∫mero ‚Äî <code class="bg-gray-100 px-1 rounded">toNumber('42')</code></li>
            <li><b>trim(s)</b> (backend) ‚Üí <i>string</i>: recorta espacios ‚Äî <code class="bg-gray-100 px-1 rounded">trim(' hola ')</code></li>
            <li><b>upper(x)</b>, <b>lower(x)</b> (backend) ‚Üí <i>string</i> ‚Äî <code class="bg-gray-100 px-1 rounded">upper(name)</code></li>
            <li><b>contains(hay, needle)</b> (backend) ‚Üí <i>boolean</i> ‚Äî <code class="bg-gray-100 px-1 rounded">contains(name, 'ana')</code></li>
            <li><b>startsWith(s, pref)</b>, <b>endsWith(s, suf)</b> (backend) ‚Üí <i>boolean</i> ‚Äî <code class="bg-gray-100 px-1 rounded">startsWith(code,'ES-')</code></li>
            <li><b>isEmpty(x)</b> (backend) ‚Üí <i>boolean</i>: vac√≠o/null ‚Äî <code class="bg-gray-100 px-1 rounded">isEmpty(email)</code></li>
            <li><b>coalesce(a,b,c,...)</b> (backend) ‚Üí <i>any</i>: primer valor no vac√≠o (retorna el primer argumento con valor; tipo seg√∫n el argumento elegido) ‚Äî <code class="bg-gray-100 px-1 rounded">coalesce(alias, name, 'N/A')</code></li>
            <li><b>isNull(x)</b>, <b>isNotNull(x)</b> (backend) ‚Üí <i>boolean</i> ‚Äî <code class="bg-gray-100 px-1 rounded">isNotNull(user_id)</code></li>
            <li><b>isDefined(x)</b>, <b>isUndefined(x)</b> (backend) ‚Üí <i>boolean</i> ‚Äî <code class="bg-gray-100 px-1 rounded">isDefined(resp.data)</code></li>
            <li class="text-gray-700"><b>parseInt(x)</b> (editor) ‚Üí <i>number</i>. <span class="text-xs text-gray-500">√ötil en el editor; el IF backend no la eval√∫a.</span></li>
            <li class="text-gray-700"><b>parseFloat(x)</b> (editor) ‚Üí <i>number</i>. <span class="text-xs text-gray-500">√ötil en el editor; el IF backend no la eval√∫a.</span></li>
            <li class="text-gray-700"><b>bool(x)</b> (editor) ‚Üí <i>boolean</i>. <span class="text-xs text-gray-500">√ötil en el editor; el IF backend no la eval√∫a.</span></li>
          </ul>
          <div class="mt-2">
            <div class="text-xs font-semibold mb-1">Composici√≥n:</div>
            <pre class="bg-gray-100 p-2 rounded text-xs">len(split('a,b,c', ','))             // 3
join(split('x|y|z','|'), ', ')       // "x, y, z"
coalesce(trim(nickname), name, 'invitado')

// Listas
items = addItem(items, 'nuevo')       // agrega al final
items = addItem(items, 'X', 1)        // inserta en √≠ndice 1
items = removeItem(items, 'b')        // quita primera coincidencia
items = removeAt(items, 0)            // quita el primer elemento</pre>
          </div>
        </div>

        <!-- Rutas -->
        <div class="p-3 bg-white rounded border" id="rutas">
          <h4 class="font-semibold mb-2">Rutas a propiedades y listas</h4>
          <ul class="list-disc pl-6 space-y-1">
            <li>Propiedad anidada: <code class="bg-gray-100 px-1 rounded">user.name</code>, <code class="bg-gray-100 px-1 rounded">resp.data.title</code></li>
            <li>√çndice de lista: <code class="bg-gray-100 px-1 rounded">items[0]</code>, <code class="bg-gray-100 px-1 rounded">resp.data.items[0].id</code></li>
            <li>Acceso dentro de loop: <code class="bg-gray-100 px-1 rounded">item</code>, <code class="bg-gray-100 px-1 rounded">index</code></li>
          </ul>
          <div class="mt-2">
            <div class="text-xs font-semibold mb-1">Atajos √∫tiles:</div>
            <ul class="list-disc pl-6 space-y-2 text-xs">
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">coalesce(trim(user.nickname), user.name, 'invitado')</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="coalesce(trim(user.nickname), user.name, 'invitado')">Copiar</button>
              </li>
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">len(items)</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="len(items)">Copiar</button>
              </li>
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">join(items, ', ')</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="join(items, ', ')">Copiar</button>
              </li>
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">contains(lower(user.name), 'ana')</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="contains(lower(user.name), 'ana')">Copiar</button>
              </li>
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">isDefined(resp.data) &amp;&amp; !isEmpty(resp.data)</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="isDefined(resp.data) && !isEmpty(resp.data)">Copiar</button>
              </li>
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">addItem(items, 'nuevo')</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="addItem(items, 'nuevo')">Copiar</button>
              </li>
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">removeItem(items, 'b')</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="removeItem(items, 'b')">Copiar</button>
              </li>
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">removeAt(items, 0)</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="removeAt(items, 0)">Copiar</button>
              </li>
            </ul>
          </div>
        </div>

        <!-- Nulos y vac√≠os -->
        <div class="p-3 bg-white rounded border" id="nulos">
          <h4 class="font-semibold mb-2">Nulos y vac√≠os (backend)</h4>
          <ul class="list-disc pl-6 space-y-1">
            <li><code class="bg-gray-100 px-1 rounded">undefined</code> se trata como <code class="bg-gray-100 px-1 rounded">null</code> en el backend.</li>
            <li>¬øes nulo o vac√≠o? ‚Üí <code class="bg-gray-100 px-1 rounded">isEmpty(x)</code></li>
            <li>¬øtiene contenido? ‚Üí <code class="bg-gray-100 px-1 rounded">!isEmpty(x)</code></li>
            <li>¬øest√° definido? ‚Üí <code class="bg-gray-100 px-1 rounded">isDefined(x)</code></li>
            <li>Equivalencia com√∫n: <code class="bg-gray-100 px-1 rounded">x != undefined &amp;&amp; x != null</code> ‚âà <code class="bg-gray-100 px-1 rounded">x != null</code></li>
          </ul>
          <pre class="bg-gray-100 p-2 rounded text-xs mt-2">isEmpty(email) || len(items) == 0
isDefined(resp.data) &amp;&amp; !isEmpty(resp.data)</pre>
        </div>

        <!-- Uso por contexto -->
        <div class="p-3 bg-white rounded border" id="uso">
          <h4 class="font-semibold mb-2">Uso por contexto</h4>
          <ul class="list-disc pl-6 space-y-1">
            <li>Condici√≥n (backend IF): <code class="bg-gray-100 px-1 rounded">len(items) &gt; 0</code>, <code class="bg-gray-100 px-1 rounded">isEmpty(x)</code></li>
            <li>Asignaci√≥n (backend): <code class="bg-gray-100 px-1 rounded">x = toNumber('42')</code>, <code class="bg-gray-100 px-1 rounded">y = join(items, ',')</code></li>
            <li>Texto (plantillas): <code class="bg-gray-100 px-1 rounded">Hola {{ upper(user_name) }}</code></li>
            <li>JSON embebido en texto: escapa comillas ‚Äî <code class="bg-gray-100 px-1 rounded">{"user":"{{ user_name }}"}</code></li>
          </ul>
        </div>

        <!-- IF ejemplos -->
        <div class="p-3 bg-white rounded border" id="if">
          <h4 class="font-semibold mb-2">Ejemplos r√°pidos de IF (backend)</h4>
          <p class="text-xs text-gray-600 mb-2">Sugerencia: usa nombres de variables sin {{ }}. Tambi√©n funcionan con {{ var }} si lo prefieres.</p>
          <ul class="list-disc pl-6 space-y-2">
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">isEmpty(my_var)</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="isEmpty(my_var)">Copiar</button>
              <span class="text-xs text-gray-500">nulo/vac√≠o</span>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">!isEmpty(my_var)</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="!isEmpty(my_var)">Copiar</button>
              <span class="text-xs text-gray-500">tiene contenido</span>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">isDefined(my_var) &amp;&amp; !isEmpty(my_var)</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="isDefined(my_var) && !isEmpty(my_var)">Copiar</button>
              <span class="text-xs text-gray-500">definido y no vac√≠o</span>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">my_var == null</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="my_var == null">Copiar</button>
              <span class="text-xs text-gray-500">nulo/undefined</span>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">my_var != null</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="my_var != null">Copiar</button>
              <span class="text-xs text-gray-500">tiene alg√∫n valor</span>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">len(items) &gt; 0</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="len(items) > 0">Copiar</button>
              <span class="text-xs text-gray-500">lista no vac√≠a</span>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">contains(name, 'ana')</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="contains(name, 'ana')">Copiar</button>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">startsWith(code, 'ES-')</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="startsWith(code, 'ES-')">Copiar</button>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">coalesce(alias, name, 'N/A') != 'N/A'</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="coalesce(alias, name, 'N/A') != 'N/A'">Copiar</button>
              <span class="text-xs text-gray-500">alguno de alias/name presente</span>
            </li>
          </ul>
        </div>

        <!-- Tipos de nodo -->
        <div class="p-3 bg-white rounded border" id="tipos">
          <h4 class="font-semibold mb-2">Tipos de nodo soportados (motor backend)</h4>
          <ul class="list-disc pl-6 space-y-1">
            <li><b>start</b>: declara variables iniciales</li>
            <li><b>response</b>: muestra texto con {{ vars }}</li>
            <li><b>input</b>: guarda entrada del usuario</li>
            <li><b>choice</b>: opciones; o modo switch por casos</li>
            <li><b>button</b> / <b>multi_button</b>: botones est√°ticos o din√°micos</li>
            <li><b>assign_var</b>: asigna valores con funciones (len, split, join, toNumber, trim, upper/lower, contains, startsWith/endsWith, isEmpty, coalesce)</li>
            <li><b>rest_call</b>: llamadas HTTP con mapeos</li>
            <li><b>agent_call</b>: invoca un agente (normal/RAG) y puede streamear o guardar en variable</li>
            <li><b>condition (if)</b>: eval√∫a expresi√≥n booleana</li>
            <li><b>loop</b>: foreach / while con <code>item</code> e <code>index</code></li>
            <li><b>set_goto</b>: redirige el siguiente salto por variable</li>
            <li><b>flow_jump / flow_return</b>: cambia de flujo y retorna</li>
            <li><b>extra</b>: punto interactivo para que el cliente env√≠e un payload por <code>request.extra</code> y desbloquee el flujo (valor ef√≠mero; persiste con <b>assign_var</b> si lo necesitas)</li>
            <li><b>end</b>: finaliza el flujo</li>
            <li><b>debug</b>: log r√°pido, √∫til para diagn√≥stico</li>
          </ul>
        </div>

                <!-- Perfiles del Simulador -->
        <div class="p-3 bg-sky-50 rounded border border-sky-300" id="sim_profiles">
          <h4 class="font-semibold mb-2 text-sky-900">üîß Gesti√≥n de Perfiles del Simulador</h4>
          <div class="p-3 bg-white rounded border border-sky-200 mb-3">
            <p class="text-sm font-semibold text-sky-700 mb-2">‚úÖ Almacenamiento seguro en localStorage</p>
            <p class="text-sm">Los perfiles de credenciales se almacenan de forma segura en <b>localStorage del navegador</b> y solo existen en el simulador. <b>No se incluyen en el JSON del flujo</b>, por lo que no hay riesgo de exponer secretos al exportar o versionar el flujo.</p>
          </div>

          <div class="space-y-4">
            <!-- C√≥mo usar la Gesti√≥n de Perfiles -->
            <div class="border-l-4 border-green-500 pl-4 bg-green-50 p-3 rounded">
              <h5 class="font-semibold text-lg mb-2">‚úÖ C√≥mo usar la Gesti√≥n de Perfiles</h5>
              <p class="text-sm mb-2">Usa el bot√≥n <b>"Gesti√≥n de Perfiles"</b> en la cabecera del simulador para:</p>
              <ul class="list-disc pl-6 space-y-1 text-sm">
                <li><b>Crear perfiles:</b> Define credenciales de Azure OpenAI y Azure AI Search</li>
                <li><b>Editar perfiles:</b> Modifica endpoints, API keys, deployments y configuraci√≥n de √≠ndices</li>
                <li><b>Activar/desactivar:</b> Cambia entre perfiles con un solo clic</li>
                <li><b>Gestionar entornos:</b> Separa configuraciones de dev, staging, producci√≥n, etc.</li>
                <li><b>Ver perfil activo:</b> Identifica qu√© credenciales est√° usando el simulador en cada momento</li>
              </ul>
              <p class="text-sm mt-3 font-semibold text-green-700">
                üîí Los perfiles se guardan en localStorage (<code>sim.profiles.v1</code>) y <b>nunca</b> se incluyen en el JSON exportado. Es completamente seguro.
              </p>
            </div>

            <!-- Campos de un perfil -->
            <div class="border-l-4 border-blue-500 pl-4 bg-blue-50 p-3 rounded">
              <h5 class="font-semibold text-lg mb-2">üìã Campos de un perfil</h5>
              <p class="text-sm mb-2"><b>Azure OpenAI (obligatorio para agent_call):</b></p>
              <ul class="list-disc pl-6 space-y-1 text-sm mb-3">
                <li><code>aoai_endpoint</code>: URL del recurso (ej: "https://mi-openai.openai.azure.com")</li>
                <li><code>aoai_api_key</code>: API Key de Azure OpenAI</li>
                <li><code>aoai_api_version</code>: Versi√≥n de API (ej: "2025-01-01-preview")</li>
                <li><code>aoai_chat_deployment</code>: Nombre del deployment (ej: "gpt-4", "gpt-4o")</li>
              </ul>
              <p class="text-sm mb-2"><b>Azure AI Search (opcional, para RAG):</b></p>
              <ul class="list-disc pl-6 space-y-1 text-sm">
                <li><code>ai_search_endpoint</code>: URL del servicio de b√∫squeda</li>
                <li><code>ai_search</code>: API Key de Azure AI Search</li>
                <li><code>ai_search_default_index</code>: √çndice por defecto para consultas RAG</li>
              </ul>
            </div>

            <!-- Flujo de trabajo -->
            <div class="border-l-4 border-purple-500 pl-4 bg-purple-50 p-3 rounded">
              <h5 class="font-semibold text-lg mb-2 text-purple-800">üìã Flujo de trabajo paso a paso</h5>
              <ol class="list-decimal pl-6 space-y-2 text-sm">
                <li><b>Abrir Gesti√≥n de Perfiles:</b> Clic en el bot√≥n "Gesti√≥n de Perfiles" en la cabecera del simulador</li>
                <li><b>Crear nuevo perfil:</b> 
                  <ul class="list-disc pl-6 mt-1">
                    <li>Clic en "Nuevo Perfil"</li>
                    <li>Asignar un nombre descriptivo (ej: "dev", "prod", "mi-cuenta-personal")</li>
                    <li>Completar credenciales de Azure OpenAI (obligatorio)</li>
                    <li>Opcionalmente, agregar credenciales de Azure AI Search para RAG</li>
                  </ul>
                </li>
                <li><b>Guardar perfil:</b> Los datos se almacenan autom√°ticamente en localStorage del navegador</li>
                <li><b>Activar perfil:</b> Seleccionar el perfil deseado y hacer clic en "Activar"</li>
                <li><b>Probar flujo:</b> Ejecutar tu flujo con nodos <code>agent_call</code> (usar√°n el perfil activo autom√°ticamente)</li>
                <li><b>Cambiar de perfil:</b> Repetir el paso 4 para activar otro perfil cuando sea necesario</li>
                <li><b>Exportar flujo:</b> Al exportar, las credenciales NO se incluyen (totalmente seguro para versionar)</li>
              </ol>
            </div>

            <!-- Seguridad -->
            <div class="border-l-4 border-green-600 pl-4 bg-green-50 p-3 rounded">
              <h5 class="font-semibold text-lg mb-2 text-green-800">üîí Seguridad y funcionamiento</h5>
              <div class="space-y-2 text-sm">
                <p><b>‚úÖ localStorage:</b> Los perfiles se almacenan localmente en tu navegador (clave <code>sim.profiles.v1</code>), nunca se env√≠an a ning√∫n servidor</p>
                <p><b>‚úÖ No se exportan:</b> Al exportar el flujo, las credenciales NO se incluyen en el JSON</p>
                <p><b>‚úÖ Solo simulador:</b> Los perfiles solo funcionan en el simulador, no afectan el backend de producci√≥n</p>
                <p><b>‚úÖ Versionado seguro:</b> Puedes commitear y versionar flujos sin preocuparte por exponer credenciales</p>
                <p><b>‚úÖ Por navegador:</b> Cada navegador/m√°quina tiene sus propios perfiles (no se sincronizan autom√°ticamente)</p>
              </div>
            </div>

            <!-- Backend en producci√≥n -->
            <div class="border-l-4 border-blue-600 pl-4 bg-blue-50 p-3 rounded">
              <h5 class="font-semibold text-lg mb-2 text-blue-800">üöÄ Credenciales en Producci√≥n (Backend)</h5>
              <p class="text-sm mb-2">Los perfiles del simulador son <b>solo para desarrollo local</b>. En producci√≥n, el backend maneja las credenciales de forma centralizada y segura:</p>
              <ul class="list-disc pl-6 space-y-1 text-sm">
                <li><b>Azure Key Vault:</b> Almacenamiento seguro de secretos (API keys, connection strings)</li>
                <li><b>Variables de entorno:</b> Configuraci√≥n desde <code>appsettings.json</code> o variables del sistema</li>
                <li><b>Managed Identity:</b> Autenticaci√≥n sin credenciales expl√≠citas usando identidades administradas de Azure</li>
                <li><b>Separaci√≥n de entornos:</b> Diferentes configuraciones para dev, staging y producci√≥n</li>
              </ul>
              <p class="text-sm mt-3 font-semibold text-blue-700">
                üí° Los usuarios finales nunca configuran credenciales. El backend las maneja autom√°ticamente.
              </p>
            </div>

            <!-- Troubleshooting -->
            <div class="border-l-4 border-amber-500 pl-4 bg-amber-50 p-3 rounded">
              <h5 class="font-semibold text-lg mb-2 text-amber-800">üîß Troubleshooting</h5>
              <details class="text-sm">
                <summary class="font-semibold cursor-pointer hover:text-amber-900">‚ùå "No hay perfil activo" al ejecutar agent_call</summary>
                <div class="mt-2 pl-4">
                  <p class="mb-2"><b>Causa:</b> No hay ning√∫n perfil activado en el simulador.</p>
                  <p class="mb-2"><b>Soluci√≥n:</b></p>
                  <ol class="list-decimal pl-6 space-y-1">
                    <li>Abre "Gesti√≥n de Perfiles"</li>
                    <li>Si no tienes perfiles, crea uno nuevo</li>
                    <li>Selecciona el perfil y haz clic en "Activar"</li>
                    <li>Vuelve a ejecutar el flujo</li>
                  </ol>
                </div>
              </details>
              <details class="text-sm mt-2">
                <summary class="font-semibold cursor-pointer hover:text-amber-900">‚ùå Error de autenticaci√≥n (401 Unauthorized)</summary>
                <div class="mt-2 pl-4">
                  <p class="mb-2"><b>Causa:</b> API Key incorrecta, expirada o sin permisos.</p>
                  <p class="mb-2"><b>Soluci√≥n:</b></p>
                  <ol class="list-decimal pl-6 space-y-1">
                    <li>Verifica que la API Key sea correcta en Azure Portal</li>
                    <li>Comprueba que el recurso de Azure OpenAI est√© activo</li>
                    <li>Edita el perfil en "Gesti√≥n de Perfiles" y actualiza las credenciales</li>
                    <li>Guarda y reactiva el perfil</li>
                  </ol>
                </div>
              </details>
              <details class="text-sm mt-2">
                <summary class="font-semibold cursor-pointer hover:text-amber-900">‚ùå No encuentro mis perfiles en otro navegador</summary>
                <div class="mt-2 pl-4">
                  <p class="mb-2"><b>Causa:</b> Los perfiles se almacenan en localStorage del navegador, no se sincronizan entre navegadores o m√°quinas.</p>
                  <p class="mb-2"><b>Soluci√≥n:</b></p>
                  <ul class="list-disc pl-6 space-y-1">
                    <li>Recrea los perfiles manualmente en cada navegador/m√°quina</li>
                    <li>O exporta/importa manualmente copiando la clave <code>sim.profiles.v1</code> de localStorage</li>
                  </ul>
                </div>
              </details>
            </div>
          </div>
        </div>


        <!-- Insertar ejemplo -->
        <div class="p-3 bg-gray-50 rounded border">
          <div class="font-semibold mb-1">Insertar ejemplo en el canvas</div>
          <p class="mb-2">Crea un flujo m√≠nimo con variables, conteo, join y toNumber:</p>
          <ol class="list-decimal pl-6 space-y-1 mb-3">
            <li>Start ‚Üí define variable <code>items</code> como lista</li>
            <li>Assign: <code>items = split('a,b,c', ',')</code></li>
            <li>Assign: <code>items_count = len(items)</code></li>
            <li>Assign: <code>csv = join(items, ';')</code></li>
            <li>Assign: <code>n = toNumber('42')</code></li>
            <li>Response: <code>Tienes {{ items_count }} elementos; csv={{ csv }}; n={{ n }}</code></li>
            <li>End: finaliza el flujo</li>
          </ol>
          <button id="btnInsertExample" class="px-3 py-2 bg-sky-600 text-white rounded text-sm">Insertar ejemplo</button>
        </div>

        <hr class="my-2"/>
        <!-- Ayuda del simulador -->
        <div>
          <h4 class="text-base font-semibold">Ayuda del Simulador (resumen)</h4>
          <div class="mt-2 space-y-3">
            <div>
              <h5 class="font-semibold text-sky-600">üìù Variables</h5>
              <p>Interpolaci√≥n en textos con <code class="bg-gray-100 px-1 rounded">{{variable}}</code>:</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">Hola {{user_name}}, tienes {{user_age}} a√±os</pre>
            </div>
            <div>
              <h5 class="font-semibold text-sky-600">üé® Markdown</h5>
              <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                <li><code>**negrita**</code>, <code>*cursiva*</code>, <code># T√≠tulo</code>, listas y <code>`c√≥digo`</code></li>
              </ul>
            </div>
            <div>
              <h5 class="font-semibold text-sky-600">üìä DataInfo</h5>
              <p>Permite construir JSON con variables interpoladas:</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">{"user":"{{user_name}}","age":{{user_age}}}</pre>
            </div>
            <div>
              <h5 class="font-semibold text-sky-600">üí° Consejos</h5>
              <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                <li>Las variables y Markdown se renderizan en el chat del simulador</li>
                <li>Escapa comillas en JSON cuando sea necesario</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Ejemplos por tipo -->
        <div id="ejemplos">
          <h4 class="text-base font-semibold">Ejemplos por tipo de elemento</h4>
          <div class="mt-2">
            <details class="mb-2"><summary class="font-semibold">Start</summary>
              <p class="text-xs mt-1">Declara variables iniciales del flujo.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">variables: [
  { "name": "items", "isList": true, "defaultValue": "[]" },
  { "name": "user_name", "defaultValue": "" }
]</pre>
            </details>
            <details class="mb-2"><summary class="font-semibold">Response</summary>
              <p class="text-xs mt-1">Muestra texto (array de strings). Soporta Markdown y {{ vars }}.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">i18n: { es: { text: [
  "Hola {{ user_name }}", "Tienes {{ len(items) }} elementos"
]}}</pre>
            </details>
            <details class="mb-2"><summary class="font-semibold">Input</summary>
              <p class="text-xs mt-1">Pide un valor y lo guarda en una variable.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">i18n: { es: { prompt: "Tu nombre" } },
save_as: "user_name"</pre>
            </details>
            <details class="mb-2"><summary class="font-semibold">Assign Variable</summary>
              <p class="text-xs mt-1">Asigna valores (expresiones soportadas: len, split, join, toNumber, bool...).</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">assignments: [
  { "target": "items", "value": "split('a,b,c', ',')" },
  { "target": "items_count", "value": "len(items)" },
  { "target": "csv", "value": "join(items, ';')" },
  { "target": "n", "value": "toNumber('42')" },
  { "target": "user.name", "value": "'Ana'" }
]</pre>
            </details>
            <details class="mb-2"><summary class="font-semibold">Condition</summary>
              <p class="text-xs mt-1">Eval√∫a una expresi√≥n booleana y redirige por true/false.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">expr: "len(items) &gt; 0",
true_target: { node_id: "res_ok" },
false_target: { node_id: "res_vacio" }</pre>
            </details>
            <details class="mb-2"><summary class="font-semibold">ForEach</summary>
              <p class="text-xs mt-1">Itera una lista y expone <code>item</code> y <code>index</code>.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">type: "foreach",
source_list: "items",
item_var: "item",
index_var: "index",
loop_body: { node_id: "resp_item" }</pre>
            </details>
            <details class="mb-2"><summary class="font-semibold">Button/Choice</summary>
              <p class="text-xs mt-1">Ofrece opciones; cada opci√≥n apunta a un siguiente nodo.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">options: [
  { "label": "S√≠", "target": { "node_id": "n_ok" } },
  { "label": "No", "target": { "node_id": "n_ko" } }
]</pre>
            </details>
            <details class="mb-2" id="rest_call"><summary class="font-semibold">REST Call</summary>
              <p class="text-xs mt-1">Realiza llamadas HTTP. Soporta {{variables}} en la URL.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">method: "GET",
url: "https://api.example.com/user/{{ user_id }}",
save_as: "resp"</pre>
            </details>
            <details class="mb-2" id="extra_node"><summary class="font-semibold">Extra</summary>
              <p class="text-xs mt-1">Nodo interactivo que espera un valor desde el cliente v√≠a <code>request.extra</code>. El backend lo emite como elemento <i>Extra</i> con <code>nodeId</code>. El frontend decide qu√© enviar (p. ej., seg√∫n el <code>nodeId</code>) y, al recibirlo, el flujo avanza a <code>next</code>.</p>
              <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                <li>El valor de <code>extra</code> es ef√≠mero en backend (se limpia al final del paso).</li>
                <li>Si necesitas conservarlo, a√±ade un <b>assign_var</b> inmediatamente despu√©s para copiar <code>{{ extra }}</code> a una variable.</li>
                <li><b>No requiere prompt</b>; basta con el <code>id</code> del nodo y el <code>next</code>.</li>
              </ul>
              <div class="text-xs mt-2 font-semibold">Ejemplo m√≠nimo</div>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">type: "extra",
id: "extra_confirm",
next: { node_id: "fin" }</pre>
              <div class="text-xs mt-2 font-semibold">Persistir el valor con AssignVar</div>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">// extra (interactivo)
type: "extra",
id: "extra_datos",
next: { node_id: "save_extra" }

// asignaci√≥n posterior
type: "assign_var",
id: "save_extra",
assignments: [
  { "target": "decision", "value": "{{ extra.confirm }}" }
]</pre>
            </details>
            <details class="mb-2" id="agent_call"><summary class="font-semibold">Agent Call</summary>
              <p class="text-xs mt-1">Invoca un agente interno. Puede emitir streaming o funcionar en modo no‚Äëstream guardando la respuesta en una variable.</p>
              <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                <li><b>stream=true</b>: se env√≠an chunks de texto como <i>Stream</i>; el √∫ltimo evento trae <code>isFinal=true</code>.</li>
                <li><b>stream=false</b>: no se pinta directamente; se espera la respuesta completa y se guarda en <code>save_as</code>.</li>
              </ul>
              <div class="text-xs mt-2 font-semibold">Sustituci√≥n de variables y {{input}}</div>
              <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                <li>El backend persiste autom√°ticamente <code>request.input</code> en las variables <code>input</code> y <code>last_user_input</code> al inicio del request.</li>
                <li>Para que el prompt incluya la entrada del usuario, usa <code>{{ input }}</code> en <b>message</b> y, si aplica, en <b>system_prompt</b>.</li>
                <li>Evita placeholders con saltos de l√≠nea dentro de <code>{{ }}</code>; escribe <code>{{ input }}</code> en una sola l√≠nea.</li>
                <li>Diagn√≥stico: los logs del backend imprimen un preview del <b>message</b> y del <b>system_prompt</b> justo antes de llamar al LLM. Si <b>message</b> est√° vac√≠o, la llamada se omite de forma segura.</li>
              </ul>
              <div class="text-xs mt-2 font-semibold">Campos principales</div>
              <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                <li><code>agent</code> o <code>agent_profile</code>: nombre del perfil de agente a usar (alias soportado por el backend).</li>
                <li><code>message</code>: prompt del usuario (puede interpolar variables).</li>
                <li><code>system_prompt</code>: instrucciones del sistema/rol.</li>
                <li><code>thread_var</code>: variable donde se guarda el id de hilo para mantener contexto conversacional entre nodos.</li>
                <li><code>save_as</code>: variable donde se guarda el resultado cuando <code>stream=false</code>.</li>
                <li><code>stream</code>: <code>true</code> para SSE en vivo; <code>false</code> para ejecuci√≥n sincronizada sin pintar directo.</li>
              </ul>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">type: "agent_call",
agent: "rag",  // o usa agent_profile: "rag"
message: "{{ agent_message }}",
system_prompt: "Instrucciones del sistema...",
thread_var: "agent_thread_id",
save_as: "agent_result",
stream: false</pre>
              <p class="text-[11px] text-gray-600 mt-1">Sugerencia: con <code>stream:false</code> muestra luego un <b>response</b> que use <code>{{ agent_result.data.text }}</code> u otra propiedad.</p>
              <div class="text-xs mt-2 font-semibold">Perfiles de agente (cu√°ndo usar cada uno)</div>
              <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                <li><b>normal</b>: conversaci√≥n/razonamiento directo sin recuperaci√≥n externa. √ösalo para respuestas libres basadas solo en el prompt.</li>
                <li><b>rag</b>: grounding con Azure AI Search y citaciones; requiere configurar √≠ndices/b√∫squeda. √ösalo cuando necesites respuestas con contexto documental.</li>
                <li><b>coordinator</b>: orquesta participantes/herramientas y fusiona respuestas. √ösalo para flujos con m√∫ltiples agentes especializados.</li>
                <li><b>retrieval</b>: solo recuperaci√≥n de contexto desde el √≠ndice, sin generar respuesta. √ösalo para preparar contexto que luego pintar√°s con un <b>response</b>.</li>
                <li><b>domain_expert</b>: experto de dominio con pol√≠ticas/tono; sin recuperaci√≥n por defecto. √ösalo cuando quieras respuestas consistentes a un √°rea espec√≠fica.</li>
              </ul>
              <div id="agent_profiles_table" class="mt-2">
                <table class="w-full text-xs border border-gray-200">
                  <thead>
                    <tr class="bg-gray-50">
                      <th class="text-left p-2 border-b">Perfil</th>
                      <th class="text-left p-2 border-b">Qu√© hace</th>
                      <th class="text-left p-2 border-b">Cu√°ndo usar</th>
                      <th class="text-left p-2 border-b">Requisitos/Notas</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="p-2 align-top">normal</td>
                      <td class="p-2 align-top">Generaci√≥n directa sin recuperaci√≥n externa.</td>
                      <td class="p-2 align-top">Respuestas libres guiadas por <code>system_prompt</code>.</td>
                      <td class="p-2 align-top">Ignora <code>search</code>; opcional configurar <code>model</code>.</td>
                    </tr>
                    <tr class="bg-gray-50/50">
                      <td class="p-2 align-top">rag</td>
                      <td class="p-2 align-top">Grounding con Azure AI Search y citaciones.</td>
                      <td class="p-2 align-top">Cuando necesitas evidencias/documentos.</td>
                      <td class="p-2 align-top">Configura <code>search.mode</code>, <code>search.indexes</code>, <code>topK</code> y (si <i>semantic/hybrid</i>) <code>semanticConfiguration</code>.</td>
                    </tr>
                    <tr>
                      <td class="p-2 align-top">coordinator</td>
                      <td class="p-2 align-top">Orquesta subagentes/herramientas y consolida la respuesta.</td>
                      <td class="p-2 align-top">Composici√≥n de varios agentes especializados.</td>
                      <td class="p-2 align-top">Define <code>participants</code> y opcional <code>mode</code> (<i>group_chat|sequential|fanout</i>). Orquestaci√≥n real soportada en backend.</td>
                    </tr>
                    <tr class="bg-gray-50/50">
                      <td class="p-2 align-top">retrieval</td>
                      <td class="p-2 align-top">Recupera contexto, no genera respuesta.</td>
                      <td class="p-2 align-top">Preparar datos que pintar√°s con un <b>response</b>.</td>
                      <td class="p-2 align-top">Requiere <code>search</code>; usa <code>save_as</code>. <b>No</b> aplica <code>stream</code>.</td>
                    </tr>
                    <tr>
                      <td class="p-2 align-top">domain_expert</td>
                      <td class="p-2 align-top">Experto con pol√≠ticas/tono predefinidos.</td>
                      <td class="p-2 align-top">Respuestas consistentes en un dominio concreto.</td>
                      <td class="p-2 align-top">Sin RAG por defecto; puedes a√±adir herramientas.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="mt-2 p-2 border rounded text-[11px] text-gray-700 bg-gray-50">
                <div class="font-semibold mb-1">Estado de soporte en el backend actual</div>
                <ul class="list-disc pl-6 space-y-1">
                  <li><b>normal</b>: Soportado (stream y no-stream).</li>
                  <li><b>rag</b>: Soportado (Azure AI Search con citaciones; adjunta herramienta nativa cuando est√° disponible y hace <i>fallback</i> a concatenaci√≥n de contexto si no).</li>
                  <li><b>retrieval</b>: Soportado (devuelve solo <i>citations</i>; usa <code>save_as</code> y pinta luego con <b>response</b>).</li>
                  <li><b>domain_expert</b>: Soportado como <i>normal</i> con <b>system_prompt</b> espec√≠fico (sin RAG por defecto).</li>
                  <li><b>coordinator</b>: <span class="text-emerald-700">Soportado</span>. Implementa orquestaci√≥n real con modos <i>group_chat</i>, <i>sequential</i> y <i>fanout</i>; valida <code>participants</code> contra listas permitidas, preserva SSE (evento final con <code>isFinal=true</code>) y m√©tricas por modo/participantes. Mantiene conversaci√≥n v√≠a <code>thread_var</code>.</li>
                </ul>
              </div>
              <div class="mt-2 text-[11px] text-gray-600">
                <span class="font-semibold">Notas:</span> el coordinador agrega el uso de tokens al final de la ejecuci√≥n y, en <i>fanout</i>, selecciona autom√°ticamente la mejor respuesta con una estrategia por defecto. Pr√≥ximas mejoras: estrategias de selecci√≥n configurables y m√©tricas de adopci√≥n/coste.
              </div>
              <div class="text-xs mt-2 font-semibold">Streaming (c√≥mo habilitar y qu√© esperar)</div>
              <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                <li>Activa/desactiva desde el panel del nodo: ‚ÄúStreaming (SSE)‚Äù o establece <code>stream: true|false</code> en el JSON.</li>
                <li><b>stream=true</b>: el chat pinta una sola burbuja que se va actualizando con los chunks; el √∫ltimo evento cierra con <code>isFinal=true</code> e incluye <i>usage</i> y, si aplica, <i>citations</i>.</li>
                <li><b>stream=false</b>: el nodo NO pinta nada; guarda el resultado en <code>save_as</code>. Muestra ese valor con un nodo <b>response</b> posterior, p. ej., <code>{{ agent_result.data.text }}</code>.</li>
              </ul>
              <div id="agent_options" class="text-xs mt-3 font-semibold">Opciones del agente (todas las propiedades)</div>
              <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                <li><code>agent</code> | <code>agent_profile</code> (string): perfil del agente. Valores: <i>normal, rag, coordinator, retrieval, domain_expert</i>.</li>
                <li><code>message</code> (string): prompt del usuario. Admite variables <code>{{ }}</code>.</li>
                <li><code>system_prompt</code> (string): instrucciones/rol del sistema.</li>
                <li><code>thread_var</code> (string): variable para conservar el hilo conversacional.</li>
                <li><code>stream</code> (bool): SSE en vivo si <code>true</code>. Por defecto <code>true</code> salvo que se configure a <code>false</code>.</li>
                <li><code>save_as</code> (string): variable destino para guardar la respuesta (clave con <code>stream:false</code> o en <i>retrieval</i>).</li>
                <li><code>model</code> (obj): configuraci√≥n del modelo, p. ej.: <code>{ provider, deployment|model, temperature, max_tokens }</code>.</li>
                <li><code>tooling</code> (string[]): herramientas simples activas, p. ej. <code>["ai_search"]</code>.</li>
                <li><code>tools</code> (obj[]): herramientas avanzadas con args, p. ej.: <code>[{ name: "ai_search", args: { topK: 5 } }]</code>.</li>
                <li><code>search</code> (obj): configuraci√≥n para RAG/retrieval. Campos: <code>mode</code> (<i>keyword|semantic|vector|hybrid</i>), <code>indexes</code> (string[]), <code>topK</code> (n√∫mero), <code>semanticConfiguration</code> (string).</li>
                <li><code>participants</code> (string[]): participantes para <i>coordinator</i>.</li>
                <li><code>mode</code> (string): estrategia de orquestaci√≥n en <i>coordinator</i>: <i>group_chat|sequential|fanout</i>.</li>
                <li><code>runtime</code> (obj): l√≠mites de ejecuci√≥n, p. ej.: <code>{ timeout_ms, max_internal_steps, retry_count }</code>.</li>
              </ul>
              <div id="agent_common_errors" class="text-xs mt-3 font-semibold">Errores comunes (y c√≥mo corregirlos)</div>
              <div class="mt-1">
                <div class="font-semibold text-[11px] text-gray-700">Perfil: rag</div>
                <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                  <li>Falta <code>search.indexes</code> o <code>topK</code> ‚Üí a√±ade √≠ndices y un <code>topK</code> &gt; 0.</li>
                  <li>Modo <i>semantic/hybrid</i> sin <code>semanticConfiguration</code> ‚Üí define el nombre configurado en tu √≠ndice.</li>
                  <li>Se esperan citaciones pero no hay resultados ‚Üí revisa <code>search.mode</code>, <code>queryLanguage</code> del √≠ndice y permisos del perfil.</li>
                </ul>
                <pre class="bg-gray-100 p-2 rounded text-xs mt-1">search: { mode: "hybrid", indexes: ["tramites-es"], topK: 5, semanticConfiguration: "semantic-config-es" }</pre>
              </div>
              <div class="mt-2">
                <div class="font-semibold text-[11px] text-gray-700">Perfil: retrieval</div>
                <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                  <li>Se espera que ‚Äúpinte‚Äù en el chat ‚Üí este perfil no genera respuesta. Usa <code>save_as</code> y pinta con un <b>response</b>.</li>
                  <li>Se activa <code>stream:true</code> esperando SSE ‚Üí no aplica streaming; usa <code>stream:false</code>.</li>
                  <li>Faltan √≠ndices o <code>topK</code> ‚Üí configura <code>search</code> como en RAG.</li>
                </ul>
                <pre class="bg-gray-100 p-2 rounded text-xs mt-1">stream: false</pre>
              </div>
              <div class="mt-2">
                <div class="font-semibold text-[11px] text-gray-700">Perfil: coordinator</div>
                <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                  <li>Sin <code>participants</code> ‚Üí define al menos uno (p. ej., <i>domain_expert</i>, <i>retrieval</i>).</li>
                  <li>Configura <code>search</code> aqu√≠ esperando RAG ‚Üí pon la b√∫squeda en subagentes (p. ej., participante <i>retrieval</i> o <i>rag</i>).</li>
                  <li>Modo inv√°lido ‚Üí usa <i>group_chat</i>, <i>sequential</i> o <i>fanout</i>.</li>
                  <li>Esperas citaciones en coordinaci√≥n pero no aparecen ‚Üí aseg√∫rate de incluir un participante <i>rag</i>/<i>retrieval</i> con <code>search</code> correcto. El coordinador puede adjuntar herramientas nativas seg√∫n disponibilidad del SDK; si no, har√° <i>fallback</i> a concatenaci√≥n de contexto.</li>
                </ul>
                <pre class="bg-gray-100 p-2 rounded text-xs mt-1">agent: "coordinator"</pre>
              </div>
              <div class="mt-2">
                <div class="font-semibold text-[11px] text-gray-700">Perfil: normal</div>
                <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                  <li>Se a√±ade <code>search</code> pero no se usa ‚Üí cambia a <i>rag</i> si necesitas grounding, o elimina <code>search</code>.</li>
                  <li>Respuestas demasiado creativas ‚Üí reduce <code>model.temperature</code> o fija <code>system_prompt</code> m√°s estricto.</li>
                </ul>
              </div>
              <div class="mt-2">
                <div class="font-semibold text-[11px] text-gray-700">Perfil: domain_expert</div>
                <ul class="list-disc pl-6 space-y-1 text-xs mt-1">
                  <li>Se esperan citaciones/documentos ‚Üí este perfil no hace RAG por defecto; a√±ade herramienta de b√∫squeda o usa <i>rag</i>.</li>
                  <li>Respuestas fuera de estilo ‚Üí ajusta <code>system_prompt</code> con pol√≠ticas/tono del dominio.</li>
                </ul>
              </div>
            </details>
            <details class="mb-2"><summary class="font-semibold">Set Goto</summary>
              <p class="text-xs mt-1">Fija la variable de salto (goto) para redirigir el flujo.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">target: "nodo_destino"</pre>
            </details>
            <details class="mb-2" id="multi_button"><summary class="font-semibold">Multi Button</summary>
              <p class="text-xs mt-1">Permite seleccionar m√∫ltiples opciones, con m√≠nimos/m√°ximos.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">type: "multi_button",
options: [
  { "label": "A", "value": "A" },
  { "label": "B", "value": "B" }
],
min_selected: 1,
max_selected: 2</pre>
            </details>
            <details class="mb-2" id="flow_jump_return"><summary class="font-semibold">Flow Jump / Flow Return</summary>
              <p class="text-xs mt-1">Salta a otro flujo y retorna al terminar.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">type: "flow_jump",
target: { flow_id: "subflow", node_id: "start" }

// en el subflujo, al finalizar:
type: "flow_return"</pre>
            </details>
            <details class="mb-2" id="debug_node"><summary class="font-semibold">Debug</summary>
              <p class="text-xs mt-1">Escribe un mensaje/payload para diagn√≥stico durante la ejecuci√≥n.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">type: "debug",
message: "Valor de x",
payload: { "x": "{{ x }}" }</pre>
            </details>
            <details class="mb-2"><summary class="font-semibold">Form</summary>
              <p class="text-xs mt-1">Recolecta varios campos en una sola interacci√≥n con formulario renderizado.</p>
              <p class="text-xs mt-1"><b>Props principales:</b></p>
              <ul class="list-disc pl-6 text-xs space-y-1">
                <li><code>title</code>: T√≠tulo del formulario (admite interpolaci√≥n <code>{{ }}</code>)</li>
                <li><code>fields</code>: Array de campos con:
                  <ul class="list-disc pl-6 mt-1">
                    <li><code>name</code>: Identificador del campo</li>
                    <li><code>label</code>: Etiqueta visible (admite interpolaci√≥n)</li>
                    <li><code>placeholder</code>: Texto de ayuda en el input</li>
                    <li><code>save_as</code> o <code>var</code>: Variable donde guardar el valor (fallback a <code>name</code>)</li>
                  </ul>
                </li>
              </ul>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-2">{
  "type": "form",
  "title": "Datos de contacto",
  "fields": [
    { "name": "email", "label": "Email", "placeholder": "ejemplo@correo.com", "save_as": "user_email" },
    { "name": "age", "label": "Edad", "placeholder": "18", "save_as": "user_age" }
  ],
  "next": "process_form"
}</pre>
              <p class="text-xs mt-2"><b>Comportamiento:</b> Al hacer clic en "Enviar", los valores se guardan en las variables especificadas y el flujo contin√∫a al nodo <code>next</code>.</p>
            </details>
            <details class="mb-2"><summary class="font-semibold">End</summary>
              <p class="text-xs mt-1">Finaliza el flujo. Buenas pr√°cticas: todos los flujos deben terminar en un nodo <code>end</code>.</p>
              <pre class="bg-gray-100 p-2 rounded text-xs mt-1">type: "end"</pre>
            </details>
          </div>
        </div>
      </div>
    </div>
  </dialog>
</template>

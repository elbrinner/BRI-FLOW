<template id="tpl-help-modal">
  <dialog id="helpModal" class="w-full max-w-6xl p-0">
    <div class="bg-white flex flex-col rounded-lg shadow-lg" style="display:flex;flex-direction:column;height:90vh;max-height:90vh;">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-xl font-semibold">Ayuda rápida — Contar elementos y expresiones</h3>
        <button id="helpModalClose" class="text-gray-600 hover:text-gray-900 text-2xl" aria-label="Cerrar">✕</button>
      </div>

      <div id="helpModalBody" class="p-6 space-y-4 text-base" style="overflow-y:auto;max-height:calc(90vh - 64px);scroll-behavior:smooth;-webkit-overflow-scrolling:touch;">
        <div class="p-3 bg-white rounded border" id="indice">
          <h4 class="font-semibold mb-2 text-lg">Índice</h4>
          <ul class="list-disc pl-6 space-y-1">
            <li><a href="#quick_count" class="text-sky-700 hover:underline">Ayuda rápida — contar elementos</a></li>
            <li><a href="#quick_expr" class="text-sky-700 hover:underline">Ayuda rápida — expresiones</a></li>
            <li><a href="#full_docs" class="text-sky-700 hover:underline">Documentación completa (Expresiones / Nodos)</a></li>
            <li><a href="#agent_call" class="text-sky-700 hover:underline">Agent Call (atajos)</a></li>
          </ul>
        </div>

        <div class="p-3 bg-white rounded border" id="quick_count">
          <h4 class="font-semibold mb-2">Ayuda rápida — contar elementos</h4>
          <p class="text-sm text-gray-700">Para contar elementos de una lista, usa <code class="bg-gray-100 px-1 rounded">len(lista)</code> o <code class="bg-gray-100 px-1 rounded">count(lista)</code>.</p>
          <ul class="list-disc pl-6 space-y-2 text-sm mt-2">
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">{{ len(items) }}</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="{{ len(items) }}">Copiar</button>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">{{ count(items) }}</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="{{ count(items) }}">Copiar</button>
            </li>
            <li class="flex items-center gap-2">
              <code class="bg-gray-100 px-1 rounded">{{ len(where(users,'item.age &gt;= 18')) }}</code>
              <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="{{ len(where(users,'item.age >= 18')) }}">Copiar</button>
            </li>
          </ul>
        </div>

        <div class="p-3 bg-white rounded border" id="quick_expr">
          <h4 class="font-semibold mb-2">Ayuda rápida — expresiones</h4>
          <p class="text-sm text-gray-700">Las plantillas <code class="bg-gray-100 px-1 rounded">{{ ... }}</code> se evalúan en el backend. Para la lista completa de funciones/operadores, usa la referencia.</p>
          <div class="text-sm mt-2 flex flex-wrap items-center gap-2">
            <a class="text-sky-700 hover:underline" href="docs/expresiones.md" target="_blank" rel="noopener">Abrir referencia de expresiones</a>
            <span class="text-gray-400">·</span>
            <a class="text-sky-700 hover:underline" href="docs/nodo.md" target="_blank" rel="noopener">Abrir referencia de nodos</a>
          </div>
          <div class="mt-2">
            <div class="text-xs font-semibold mb-1">Ejemplo (sincronizado)</div>
            <ul class="list-disc pl-6 space-y-2 text-xs">
              <li class="flex items-center gap-2">
                <code class="bg-gray-100 px-1 rounded">{{ join(select(slice(orderBy(users,'item.age'), 0, 2),'item.name'), ', ') }}</code>
                <button type="button" class="px-2 py-0.5 text-xs bg-white border rounded copyExprBtn" data-expr="{{ join(select(slice(orderBy(users,'item.age'), 0, 2),'item.name'), ', ') }}">Copiar</button>
              </li>
            </ul>
          </div>
        </div>

        <div class="p-3 bg-white rounded border" id="full_docs">
          <h4 class="font-semibold mb-2">Documentación completa</h4>
          <p class="text-sm text-gray-700">Puedes cargar la referencia completa dentro de esta modal (requiere servir la app desde HTTP, no <code>file://</code>).</p>

          <details class="mt-2" id="full_expressions">
            <summary class="font-semibold">Expresiones (referencia completa)</summary>
            <div class="mt-2 flex items-center gap-2">
              <button type="button" id="helpLoadExpressions" class="px-3 py-1 bg-white border rounded text-sm">Cargar aquí</button>
              <a class="text-sky-700 hover:underline text-sm" href="docs/expresiones.md" target="_blank" rel="noopener">Abrir en pestaña</a>
            </div>
            <div id="helpExpressionsContent" class="mt-3 text-sm"></div>
          </details>

          <details class="mt-3" id="full_nodes">
            <summary class="font-semibold">Nodos (referencia completa)</summary>
            <div class="mt-2 flex items-center gap-2">
              <button type="button" id="helpLoadNodes" class="px-3 py-1 bg-white border rounded text-sm">Cargar aquí</button>
              <a class="text-sky-700 hover:underline text-sm" href="docs/nodo.md" target="_blank" rel="noopener">Abrir en pestaña</a>
            </div>
            <div id="helpNodesContent" class="mt-3 text-sm"></div>
          </details>
        </div>

        <div class="p-3 bg-white rounded border" id="agent_call">
          <h4 class="font-semibold mb-2">Agent Call</h4>
          <p class="text-sm text-gray-700">Atajo de ayuda para el nodo <code class="bg-gray-100 px-1 rounded">agent_call</code>. La referencia completa está en <a class="text-sky-700 hover:underline" href="docs/nodo.md" target="_blank" rel="noopener">docs/nodo.md</a>.</p>

          <div class="mt-3" id="agent_profiles_table">
            <div class="text-sm font-semibold">Perfiles (tabla)</div>
            <p class="text-sm text-gray-700">Perfiles frecuentes: <code class="bg-gray-100 px-1 rounded">normal</code>, <code class="bg-gray-100 px-1 rounded">rag</code>, <code class="bg-gray-100 px-1 rounded">coordinator</code>, <code class="bg-gray-100 px-1 rounded">retrieval</code>, <code class="bg-gray-100 px-1 rounded">domain_expert</code>.</p>
          </div>

          <div class="mt-3" id="agent_common_errors">
            <div class="text-sm font-semibold">Errores comunes</div>
            <ul class="list-disc pl-6 text-sm text-gray-700 mt-1 space-y-1">
              <li>Usar campos legacy en raíz: al guardar se normaliza a <code class="bg-gray-100 px-1 rounded">props.*</code>.</li>
              <li>Dejar <code class="bg-gray-100 px-1 rounded">props.message</code> vacío: el runtime puede omitir la llamada.</li>
              <li>Evita credenciales en el flujo; usa perfiles (<code class="bg-gray-100 px-1 rounded">use_profile</code>).</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-end gap-2 p-4 border-t">
        <button type="button" id="btnInsertExample" class="px-3 py-1 bg-white border rounded text-sm">Insertar ejemplo</button>
      </div>
    </div>
  </dialog>
</template>

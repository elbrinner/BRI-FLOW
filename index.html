<!DOCTYPE html>
<html lang="es">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bri Flow — Editor Visual</title>
  <link rel="stylesheet" href="css/style.css">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <header class="px-4">
    <div class="flex items-center gap-4 w-full">
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2">
          <span class="text-2xl font-extrabold text-sky-600">Bri Flow</span>
          <span id="currentFlowBadge" class="ml-2 inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs bg-sky-50 text-sky-700 border border-sky-200" title="Flujo activo">
            <span aria-hidden="true">🧭</span>
            <span>(sin flujo)</span>
          </span>
        </div>
      </div>

  <div class="controls ml-auto flex items-center gap-2" aria-label="Controles del editor">
       
      
         <span class="panel-toggles inline-flex items-center gap-2 ml-3">
          <button id="togglePaletteBtn" title="Mostrar / Ocultar paleta" class="px-3 py-1 bg-white border rounded text-sm">
            <span class="inline-flex items-center gap-2">
              <span aria-hidden="true">🛠️</span>
              <span>Nodos</span>
            </span>
          </button>
         
        </span>
        <button id="btnOpenFlows" class="px-3 py-1 bg-white border rounded text-sm" title="Gestionar flujos del proyecto">
          <span class="inline-flex items-center gap-2">
            <svg aria-hidden="true" class="w-4 h-4 text-sky-600" viewBox="0 0 24 24" fill="currentColor">
              <path d="M4 6h16v2H4zM4 11h16v2H4zM4 16h10v2H4z"></path>
            </svg>
            <span>Flujos</span>
          </span>
        </button>
        <button id="btnExport" class="px-3 py-1 bg-white border rounded text-sm">
          <span class="inline-flex items-center gap-2">
            <!-- Floppy disk icon -->
            <svg aria-hidden="true" class="w-4 h-4 text-gray-700" viewBox="0 0 24 24" fill="currentColor">
              <rect x="3" y="3" width="18" height="18" rx="2"></rect>
              <rect x="7" y="4.5" width="7" height="6" fill="white" opacity="0.9"></rect>
              <rect x="7" y="14" width="10" height="5" fill="white" opacity="0.9"></rect>
              <rect x="9" y="15" width="6" height="2.5" rx="0.5" class="fill-gray-300"></rect>
            </svg>
            <span>Guardar</span>
          </span>
        </button>
    <button id="btnOpenSimulatorModal" title="Abrir simulador en modal" class="px-3 py-1 bg-white border rounded text-sm">
      <span class="inline-flex items-center gap-2">
        <!-- Play icon (green) -->
        <svg aria-hidden="true" class="w-4 h-4 text-green-600" viewBox="0 0 24 24" fill="currentColor">
          <path d="M8 5v14l11-7-11-7z"></path>
        </svg>
        <span>Simulador</span>
      </span>
    </button>
  <button id="btnShowJson" title="Ver JSON generado" class="px-3 py-1 bg-white border rounded text-sm">
    <span class="inline-flex items-center gap-2">
      <!-- Code brackets icon -->
      <svg aria-hidden="true" class="w-4 h-4 text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 8L5 12l4 4"/>
        <path d="M15 8l4 4-4 4"/>
      </svg>
      <span>Ver JSON</span>
    </span>
  </button>

        <span class="zoom-controls inline-flex items-center gap-2 ml-2">
          <button id="zoomOut" title="Alejar" class="px-2 py-1 bg-white border rounded">−</button>
          <span id="zoomLabel" class="min-w-[56px] text-center font-semibold">100%</span>
          <button id="zoomIn" title="Acercar" class="px-2 py-1 bg-white border rounded">+</button>
          <button id="btnCenterCanvas" title="Centrar canvas al contenido" class="px-2 py-1 bg-white border rounded">
            <span class="inline-flex items-center gap-2">
              <!-- Crosshair/Target icon -->
              <svg aria-hidden="true" class="w-4 h-4 text-sky-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="6"></circle>
                <path d="M12 2v4M12 18v4M2 12h4M18 12h4"></path>
              </svg>
            </span>
          </button>
         
        </span>

        <!-- Botón de ayuda global -->
        <button id="btnHelpDoc" title="Ayuda de expresiones (len, split, etc.)" class="px-2 py-1 bg-white border rounded" aria-label="Ayuda">
          <span class="inline-flex items-center gap-2">
            <span aria-hidden="true">ℹ️</span>
            <span class="text-sm">Ayuda</span>
          </span>
        </button>

  <input id="importFile" type="file" accept=".json" multiple class="text-sm file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 hidden" />
  <input id="importFolder" type="file" accept=".json" webkitdirectory directory multiple class="hidden" />

       

        
      </div>
    </div>
  </header>

  <main>
  <aside id="palette" aria-label="Paleta de nodos">
      <h2>Nodos</h2>
      
      <div class="draggable start-special" draggable="true" data-type="start" title="Nodo de inicio del flujo (solo 1 por flujo)">🚀 Start</div>
            <div class="draggable" draggable="true" data-type="response">📣 Response</div>
      <div class="draggable" draggable="true" data-type="input">⌨️ Input</div>
  <div class="draggable" draggable="true" data-type="assign_var">🔧 Assign Variable</div>
  <div class="draggable" draggable="true" data-type="button">🔘 Button</div>
  <div class="draggable" draggable="true" data-type="multi_button" title="Permite seleccionar varias opciones">🧩 Multi-Button</div>
      <div class="draggable" draggable="true" data-type="rest_call">🔗 API REST Call</div>

  <div class="draggable" draggable="true" data-type="foreach" title="Itera sobre una lista (simple)">🔁 ForEach</div>

 
      <div class="draggable" draggable="true" data-type="form">📝 Form</div>
    <div class="draggable" draggable="true" data-type="choice_switch" title="Choice (switch): evalúa casos y salta automáticamente">🔀 Choice (switch)</div>
    <div class="draggable" draggable="true" data-type="flow_jump" title="Llama a otro flujo y puede volver al origen">⤴️ Flow Jump</div>
      
  <div class="draggable" draggable="true" data-type="condition">❓ Condition (If)</div>
  <div class="draggable" draggable="true" data-type="set_goto">🔙 Set Goto</div>
  <div class="draggable" draggable="true" data-type="end" title="Nodo fin del flujo">🏁 End</div>
  <hr style="margin: 12px 0; border-color: #e5e7eb;" />
  <div class="draggable" draggable="true" data-type="agent_call" title="Llamada a agente (RAG o normal)">🤖 Agent Call</div>
  <div class="draggable" draggable="true" data-type="use_profile" title="Establecer perfil de credenciales">🔐 Use Profile</div>
  <div class="draggable" draggable="true" data-type="credential_profile" title="Perfil de credenciales (simulador only)">🔑 Credential Profile</div>
  
  
    </aside>

    <section id="canvasSection" aria-label="Canvas de diseño">
      <h2>Canvas</h2>
      <section id="canvas" aria-label="Canvas de diseño">
        <div id="canvasInner"></div>
      </section>
    </section>

    <aside id="properties" aria-label="Panel de propiedades">
      <h2>Propiedades</h2>
      
  <output id="noSelection" aria-live="polite">Selecciona un nodo en el canvas para editar sus propiedades.</output>
      <form id="propForm" style="display:none;">
        <div class="form-row">
          <label for="prop_id">ID nodo</label>
          <input type="text" id="prop_id" required />
        </div>
        <div class="form-row">
          <label for="prop_type">Tipo</label>
          <input type="text" id="prop_type" disabled />
        </div>
        <div id="dynamicProps"></div>
        <div class="form-row">
          <label for="variablesList">Variables detectadas en el flujo</label>
          <div id="variablesList">(sin variables definidas)</div>
        </div>

        <div class="form-row actions flex gap-2 mt-4">
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded shadow hover:bg-green-700 transition font-semibold text-sm">Aplicar</button>
          <button type="button" id="btnDeleteNode" class="px-4 py-2 bg-red-500 text-white rounded shadow hover:bg-red-600 transition font-semibold text-sm">Eliminar nodo</button>
        </div>
      </form>
    </aside>
  </main>


    <div id="simulatorPanel" class="simulator-panel border rounded p-2 bg-white">
      <div id="simulatorTimeline" class="sim-timeline h-40 overflow-auto" style="min-height:120px;">Registro de ejecución del simulador</div>
      <div id="simulatorCanvasPreview" class="sim-canvas-preview mt-2 h-48 border rounded p-2 bg-gray-50" style="min-height:160px; margin-top:8px;">Vista previa del flujo (nodos visitados, variables, respuestas)</div>
      <div class="mt-2 flex items-center gap-2">
        <input id="simExtraInput" class="border rounded px-2 py-1 flex-1" placeholder='JSON extra por paso (ej: {"userId":42})' type="text" value="hola" />
        <button id="simExtraClear" class="px-2 py-1 bg-white border rounded text-sm" title="Limpiar JSON extra">Limpiar</button>
      </div>
      <div class="mt-2 flex items-center gap-2">
        <label for="simTurnSelect" class="text-xs text-gray-600">turn</label>
        <select id="simTurnSelect" class="border rounded px-2 py-1 text-sm">
          <option value="">(no inyectar)</option>
          <option value="user">user</option>
          <option value="assistant">assistant</option>
        </select>
        <button id="simTurnClear" class="px-2 py-1 bg-white border rounded text-sm" title="Limpiar turn">Limpiar</button>
      </div>
      <div class="mt-2 flex items-center gap-2">
        <input id="simOriginInput" class="border rounded px-2 py-1 flex-1" placeholder='origin (JSON) ej: {"role":"user","value":"hola","node":"n1"}' type="text" />
        <button id="simOriginClear" class="px-2 py-1 bg-white border rounded text-sm" title="Limpiar origin">Limpiar</button>
      </div>
      <div class="text-xs text-gray-500 mt-1">El campo extra es efímero por paso. Si quieres conservarlo, asígnalo a una variable con un nodo AssignVar.</div>
      <div class="text-xs text-gray-500">Los campos turn y origin también son efímeros por paso; se limpian automáticamente tras cada paso.</div>
    </div>
  </section>
  <section id="jsonOutSection">
    <h2>JSON generado</h2>
    <pre id="jsonOutput">{ }</pre>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/jsplumb@2.15.6/dist/js/jsplumb.min.js"></script>
  <script src="js/formbuilder.js"></script>
  <script src="js/renderers/common.js"></script>
  <script src="js/renderers/validation.js"></script>
  <script src="js/renderers/button.js"></script>
  <script src="js/renderers/multi_button_panel.js"></script>
  <script src="js/renderers/rest_call.js"></script>
  <script src="js/renderers/foreach.js"></script>
  <script src="js/renderers/while.js"></script>
  <script src="js/renderers/loop.js"></script>
  <script src="js/renderers/response.js"></script>
  <script src="js/renderers/input.js"></script>
  <script src="js/renderers/choice.js"></script>
  <script src="js/var_explorer.js"></script>
  <script src="js/renderers/assign_var.js"></script>
  <script src="js/renderers/condition.js"></script>
  <script src="js/renderers/flow_jump.js"></script>
  <script src="js/renderers/set_goto.js"></script>
  <script src="js/renderers/start.js"></script>
  <script src="js/renderers/hero_card.js"></script>
  <script src="js/renderers/carousel.js"></script>
  <script src="js/renderers/form.js"></script>
  <script src="js/renderers/file_upload.js"></script>
  <script src="js/renderers/json_export.js"></script>
  <script src="js/renderers/file_download.js"></script>
  <script src="js/renderers/end.js"></script>
  <script src="js/renderers/hidden_response.js"></script>
  <script src="js/renderer_agent_call.js"></script>
  <script src="js/renderer_use_profile.js"></script>
  <script src="js/renderer_credential_profile.js"></script>
  <script src="js/form_renderers.js"></script>
  <script src="js/connections.js"></script>
  <script src="js/variables.js"></script>
  <script src="js/node_renderer.js"></script>
  <script src="js/node_editor.js"></script>
  <script src="js/toasts.js"></script>
  <script src="js/ui_controls.js"></script>
  <script src="js/compact_mode.js"></script>
  <script src="js/app_helpers.js"></script>
  <script src="js/ui_state.js"></script>
  <script src="js/canvas_drag.js"></script>
  <script src="js/serializer.js"></script>
  <script src="js/io.js"></script>
  <script src="js/node_factory.js"></script>
  <script src="js/main.js"></script>
  <script src="js/project_flows.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/lib/marked.umd.js"></script>
  <script src="js/expression_parser.js"></script>
  <script src="js/flow_ui.js"></script>
  <script src="js/flow_runner.js"></script>
  <script src="js/runtime_demo.js"></script>
  <script src="js/simulador.js"></script>
  
  <script src="js/renderer_usage_report.js"></script>
  <script src="js/template_selftest.js"></script>
  <script>
    // Wire center canvas button
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('btnCenterCanvas');
      btn?.addEventListener('click', () => {
        try { globalThis.App?.fitCanvasToContent?.(); } catch(e){ console.warn('[UI] fitCanvasToContent failed', e); }
      });
    });
  </script>

  <!-- Modal Flujos -->
  <div id="flowsModal" class="fixed inset-0 z-[360] hidden items-center justify-center bg-black bg-opacity-40" aria-hidden="true" role="dialog" aria-modal="true" tabindex="-1">
    <div class="w-full max-w-2xl bg-white rounded-lg shadow-lg overflow-hidden flex flex-col max-h-[80vh]">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-lg font-semibold">Flujos del proyecto</h3>
        <button id="flowsModalClose" class="text-gray-600 hover:text-gray-900">✕</button>
      </div>
      <div class="p-4 space-y-3 flex-1 overflow-y-auto">
        <div class="flex items-center gap-2">
          <button id="btnCreateFlow" class="px-3 py-2 bg-sky-600 text-white rounded text-sm">Nuevo flujo</button>
          <button id="btnUpsertCurrent" class="px-3 py-2 bg-white border rounded text-sm" title="Guardar/actualizar el flujo abierto en el proyecto">Añadir/Actualizar actual</button>
          <button id="btnImportFolder" class="px-3 py-2 bg-white border rounded text-sm" title="Importar todos los .json de una carpeta">Abrir carpeta</button>
        </div>
        <div id="flowsList" class="divide-y border rounded"></div>
      </div>
      <div class="p-3 border-t text-xs text-gray-500">
        Consejo: marca un flujo como Principal para exportarlo por defecto.
      </div>
    </div>
  </div>
  <!-- Modal de Ayuda extraído: se carga desde components/help_modal.html por js/help_modal.js -->
  <script src="js/help_modal.js"></script>
    <script src="js/template_loader.js"></script>
  <!-- JSON modal -->

  <style>
    /* Backdrop y layout para dialog de ayuda */
    #helpModal::backdrop { background: rgba(0,0,0,0.4); }
    /* Layout modal simulator: left debug 40% / right chat 60%; responsive stack on small screens */
    .simulator-grid {
      display: grid;
      grid-template-columns: 40% 60%;
      gap: 0;
      height: calc(90vh - 56px);
    }
    @media (max-width: 768px){
      .simulator-grid { grid-template-columns: 1fr; height: auto; }
      .simulator-grid aside { order: -1; }
    }
    /* Ensure pre elements in debug are readable */
    #simulatorDebugPanel pre { color: #111827; background: #ffffff; }
  </style>

  <div id="jsonModal" class="modal-overlay" style="display:none" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-header">
        <h3>JSON generado</h3>
        <button id="jsonModalClose" class="modal-close">✕</button>
      </div>
      <div class="modal-body">
        <div class="modal-actions">
          <button id="jsonModalCopy" class="px-3 py-1 bg-sky-600 text-white rounded text-sm">Copiar al portapapeles</button>
        </div>
        <pre id="jsonModalContent" class="json-content">{ }</pre>
      </div>
    </div>
  </div>
  <!-- Simulador Modal (chat) -->
  <div id="simulatorModal" class="fixed inset-0 z-[300] hidden items-center justify-center bg-black bg-opacity-40" aria-hidden="true">
    <div class="w-full max-w-6xl h-[90vh] bg-white rounded-lg shadow-lg flex flex-col overflow-hidden">
      <!-- Modal header -->
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-lg font-semibold">Simulador — Chat</h3>
        <div class="flex items-center gap-2">
 
          <button id="btnShowHelp" class="px-3 py-1 bg-white border rounded text-sm" title="Mostrar ayuda">?</button>
          <button id="simulatorModalClose" class="text-gray-600 hover:text-gray-900">✕</button>
        </div>
      </div>

      <!-- Modal body: grid 40/60 -->
      <div class="modal-body flex-1 overflow-hidden p-4">
        <div class="simulator-grid h-full">
          <!-- Left: debug panel (40%) -->
          <aside id="simulatorDebugPanel" aria-label="Panel de depuración del simulador" class="border-r bg-gray-50 p-4 flex flex-col gap-4 overflow-auto text-xs">
            <div id="simulatorWarnings" class="hidden p-2 rounded border border-amber-300 bg-amber-50 text-amber-800"></div>
            <div>
              <h4 class="font-semibold mb-1 text-sm">Flow JSON</h4>
              <pre id="debugFlowJson" class="text-[11px] leading-snug bg-white border rounded p-2 max-h-40 overflow-auto">{}</pre>
            </div>
            <div>
              <h4 class="font-semibold mb-1 text-sm">Nodo actual</h4>
              <pre id="debugCurrentNode" class="text-[11px] leading-snug bg-white border rounded p-2 max-h-40 overflow-auto">{}</pre>
            </div>
            <div>
              <h4 class="font-semibold mb-1 text-sm">Variables</h4>
              <pre id="debugVariables" class="text-[11px] leading-snug bg-white border rounded p-2 max-h-40 overflow-auto">{}</pre>
            </div>
            <div>
              <h4 class="font-semibold mb-1 text-sm">Call stack</h4>
              <pre id="debugCallStack" class="text-[11px] leading-snug bg-white border rounded p-2 max-h-40 overflow-auto">(vacía)</pre>
            </div>
            <div>
              <h4 class="font-semibold mb-1 text-sm">Diff variables</h4>
              <pre id="debugVarDiff" class="text-[11px] leading-snug bg-white border rounded p-2 max-h-40 overflow-auto">(sin cambios)</pre>
            </div>
            <div>
              <h4 class="font-semibold mb-1 text-sm">Editar variables</h4>
              <div id="simulatorVarsList" class="space-y-2 overflow-auto bg-white border rounded p-2" style="max-height:28vh"></div>
            </div>
            <div class="mt-auto">
              <button id="btnVarsSave" class="w-full mb-2 px-3 py-2 bg-sky-600 text-white rounded text-sm">Guardar variables</button>
              <button id="btnVarsReset" class="w-full px-3 py-2 bg-white border rounded text-sm">Reset variables</button>
            </div>
          </aside>

          <!-- Right: chat (60%) -->
          <div class="flex-1 flex flex-col overflow-hidden bg-white">
            <div class="p-4 border-b bg-gray-50">
              <h4 class="font-semibold">Chat del simulador</h4>
            </div>
            <div id="simulatorChat" class="p-4 flex-1 overflow-auto bg-gray-50"></div>
            <div class="p-4 border-t bg-white flex gap-2 items-center">
              <input id="simulatorInputBox" type="text" placeholder="Escribe tu respuesta..." class="flex-1 px-3 py-2 border rounded-md" />
              <button id="simulatorSendBtn" class="px-4 py-2 bg-sky-600 text-white rounded">Enviar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

  <!-- JSON modal -->

</body>
</html>

<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bri Flow ‚Äî Editor Visual</title>
  <link rel="stylesheet" href="css/style.css">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
  <header class="px-4">
    <div class="flex items-center gap-4 w-full">
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2">
          <span class="text-2xl font-extrabold text-sky-600">Bri Flow</span>
          <span id="currentFlowBadge"
            class="ml-2 inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs bg-sky-50 text-sky-700 border border-sky-200"
            title="Flujo activo">
            <span aria-hidden="true">üß≠</span>
            <span id="currentFlowName">(sin flujo)</span>
            <span id="mainFlowChip"
              class="ml-1 px-2 py-0.5 rounded-full text-[10px] bg-green-100 text-green-700 border border-green-200 hidden">Principal</span>
          </span>
        </div>
      </div>

      <div class="controls ml-auto flex items-center gap-2" aria-label="Controles del editor">


        <span class="panel-toggles inline-flex items-center gap-2 ml-3">
          <button id="togglePaletteBtn" title="Mostrar / Ocultar paleta"
            class="px-3 py-1 bg-white border rounded text-sm">
            <span class="inline-flex items-center gap-2">
              <span aria-hidden="true">üõ†Ô∏è</span>
              <span>Nodos</span>
            </span>
          </button>

        </span>
        <button id="btnOpenFlows" class="px-3 py-1 bg-white border rounded text-sm"
          title="Gestionar flujos del proyecto">
          <span class="inline-flex items-center gap-2">
            <svg aria-hidden="true" class="w-4 h-4 text-sky-600" viewBox="0 0 24 24" fill="currentColor">
              <path d="M4 6h16v2H4zM4 11h16v2H4zM4 16h10v2H4z"></path>
            </svg>
            <span>Flujos</span>
          </span>
        </button>

        <button id="btnShowJson" title="Ver JSON generado" class="px-3 py-1 bg-white border rounded text-sm">
          <span class="inline-flex items-center gap-2">
            <!-- Code brackets icon -->
            <svg aria-hidden="true" class="w-4 h-4 text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 8L5 12l4 4" />
              <path d="M15 8l4 4-4 4" />
            </svg>
            <span>Code</span>
          </span>
        </button>

        <button id="btnExport" class="px-3 py-1 bg-white border rounded text-sm">
          <span class="inline-flex items-center gap-2">
            <!-- Floppy disk icon -->
            <svg aria-hidden="true" class="w-4 h-4 text-gray-700" viewBox="0 0 24 24" fill="currentColor">
              <rect x="3" y="3" width="18" height="18" rx="2"></rect>
              <rect x="7" y="4.5" width="7" height="6" fill="white" opacity="0.9"></rect>
              <rect x="7" y="14" width="10" height="5" fill="white" opacity="0.9"></rect>
              <rect x="9" y="15" width="6" height="2.5" rx="0.5" class="fill-gray-300"></rect>
            </svg>

          </span>
        </button>
        <button id="btnOpenSimulatorModal" title="Abrir simulador en modal"
          class="px-3 py-1 bg-white border rounded text-sm">
          <span class="inline-flex items-center gap-2">
            <!-- Play icon (green) -->
            <svg aria-hidden="true" class="w-4 h-4 text-green-600" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7-11-7z"></path>
            </svg>
          </span>
        </button>
        <!-- Undo/Redo Controls -->
        <button id="btnUndo" title="Deshacer (Ctrl+Z)"
          class="px-2 py-1 bg-white border rounded text-sm hover:bg-gray-50" aria-label="Deshacer">
          <span aria-hidden="true">‚Ü©Ô∏è</span>
        </button>
        <button id="btnRedo" title="Rehacer (Ctrl+Shift+Z)"
          class="px-2 py-1 bg-white border rounded text-sm hover:bg-gray-50" aria-label="Rehacer">
          <span aria-hidden="true">‚Ü™Ô∏è</span>
        </button>
        <div class="w-px h-6 bg-gray-300 mx-1"></div>



        <span class="zoom-controls inline-flex items-center gap-2 ml-2">
          <button id="zoomOut" title="Alejar" class="px-2 py-1 bg-white border rounded">‚àí</button>
          <span id="zoomLabel" class="min-w-[56px] text-center font-semibold">100%</span>
          <button id="zoomIn" title="Acercar" class="px-2 py-1 bg-white border rounded">+</button>
          <button id="btnCenterCanvas" title="Centrar canvas al contenido" class="px-2 py-1 bg-white border rounded">
            <span class="inline-flex items-center gap-2">
              <!-- Crosshair/Target icon -->
              <svg aria-hidden="true" class="w-4 h-4 text-sky-600" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="6"></circle>
                <path d="M12 2v4M12 18v4M2 12h4M18 12h4"></path>
              </svg>
            </span>
          </button>

        </span>

        <!-- AI Copilot Button -->
        <button id="btnAiCopilot" title="Bri AI Assintent"
          class="px-2 py-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white border-0 rounded shadow-sm hover:shadow-md transition-all"
          aria-label="AI Assist">
          <span class="inline-flex items-center gap-2">
            <span aria-hidden="true">‚ú®</span>
          </span>
        </button>

        <!-- Bot√≥n de ayuda global -->
        <button id="btnHelpDoc" title="Ayuda de expresiones (len, split, etc.)"
          class="px-2 py-1 bg-white border rounded" aria-label="Ayuda">
          <span class="inline-flex items-center gap-2">
            <span aria-hidden="true">‚ÑπÔ∏è</span>
          </span>
        </button>



        <input id="importFile" type="file" accept=".json" multiple
          class="text-sm file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 hidden" />
        <input id="importFolder" type="file" accept=".json" webkitdirectory directory multiple class="hidden" />




      </div>
    </div>
  </header>

  <main>
    <aside id="palette" aria-label="Paleta de nodos">
      <h2>Nodos</h2>

      <div class="space-y-2">
        <!-- Control & Debug -->
        <details class="group" open>
          <summary class="font-semibold cursor-pointer p-2 bg-gray-100 hover:bg-gray-200 rounded select-none text-sm">
            Control & Debug</summary>
          <div class="pl-2 pt-2 space-y-1">
            <div class="draggable start-special" draggable="true" data-type="start"
              title="Nodo de inicio del flujo (solo 1 por flujo)">üöÄ Start</div>
            <div class="draggable" draggable="true" data-type="end" title="Nodo fin del flujo">üèÅ End</div>
            <div class="draggable" draggable="true" data-type="debug" title="Nodo debug: muestra mensaje y datos">üêõ
              Debug</div>

            <div class="draggable" draggable="true" data-type="flow_jump"
              title="Llama a otro flujo y puede volver al origen">‚§¥Ô∏è Flow Jump</div>
          </div>
        </details>

        <!-- Agents & AI -->
        <details class="group" open>
          <summary class="font-semibold cursor-pointer p-2 bg-gray-100 hover:bg-gray-200 rounded select-none text-sm">
            Agents & AI</summary>
          <div class="pl-2 pt-2 space-y-1">
            <div class="draggable" draggable="true" data-type="agent_call" title="Llamada a agente (RAG o normal)">ü§ñ
              Agent Call</div>
            <div class="draggable" draggable="true" data-type="voice_agent" title="Agente de voz en tiempo real">üéôÔ∏è
              Voice Agent</div>
            <div class="draggable" draggable="true" data-type="use_profile" title="Usar perfil de simulador">üîê Use
              Profile</div>
            <div class="draggable" draggable="true" data-type="credential_profile" title="Perfil de credenciales">üîë
              Credential Profile</div>
          </div>
        </details>

        <!-- Logic & Flow -->
        <details class="group" open>
          <summary class="font-semibold cursor-pointer p-2 bg-gray-100 hover:bg-gray-200 rounded select-none text-sm">
            Logic & Flow</summary>
          <div class="pl-2 pt-2 space-y-1">
            <div class="draggable" draggable="true" data-type="condition">‚ùì Condition (If)</div>
            <div class="draggable" draggable="true" data-type="choice_switch"
              title="Choice (switch): eval√∫a casos y salta autom√°ticamente">üîÄ Choice (switch)</div>
            <div class="draggable" draggable="true" data-type="loop" title="Loop gen√©rico">üîÑ Loop</div>
            <div class="draggable" draggable="true" data-type="foreach" title="Itera sobre una lista (simple)">üîÅ
              ForEach</div>
            <div class="draggable" draggable="true" data-type="while" title="Itera mientras la condici√≥n sea verdadera">
              ‚è≥ While</div>
            <div class="draggable" draggable="true" data-type="assign_var">üîß Assign Variable</div>
            <div class="draggable" draggable="true" data-type="event_start" title="Inicio por evento (webhook, timer)">‚ö°
              Event Start</div>
            <div class="draggable" draggable="true" data-type="human_validation" title="Requiere aprobaci√≥n humana">üõ°Ô∏è
              Human Validation</div>
            <div class="draggable" draggable="true" data-type="extra"
              title="Nodo Extra: espera valor externo del frontend">üß© Extra</div>
          </div>
        </details>

        <!-- UI Components -->
        <details class="group" open>
          <summary class="font-semibold cursor-pointer p-2 bg-gray-100 hover:bg-gray-200 rounded select-none text-sm">UI
            Components</summary>
          <div class="pl-2 pt-2 space-y-1">
            <div class="draggable" draggable="true" data-type="response">üì£ Response</div>
            <div class="draggable" draggable="true" data-type="hidden_response"
              title="Respuesta oculta (no visible al usuario)">üëª Hidden Response</div>
            <div class="draggable" draggable="true" data-type="input">‚å®Ô∏è Input</div>
            <div class="draggable" draggable="true" data-type="button">üîò Button</div>
            <div class="draggable" draggable="true" data-type="multi_button"
              title="Permite seleccionar varias opciones">‚úÖ Multi Select</div>
            <div class="draggable" draggable="true" data-type="form">üìù Form</div>
            <div class="draggable" draggable="true" data-type="hero_card" title="Tarjeta visual con botones">üÉè Hero
              Card</div>
            <div class="draggable" draggable="true" data-type="carousel" title="Carrusel de tarjetas">üé† Carousel</div>
          </div>
        </details>

        <!-- Tools & Data -->
        <details class="group" open>
          <summary class="font-semibold cursor-pointer p-2 bg-gray-100 hover:bg-gray-200 rounded select-none text-sm">
            Tools & Data</summary>
          <div class="pl-2 pt-2 space-y-1">
            <div class="draggable" draggable="true" data-type="rest_call">üîó API REST Call</div>
            <div class="draggable" draggable="true" data-type="file_upload" title="Subir archivo">üìé File Upload</div>
            <div class="draggable" draggable="true" data-type="json_upload"
              title="Subir JSON (env√≠a datos parseados v√≠a extra)">üìã JSON Upload</div>
            <div class="draggable" draggable="true" data-type="json_export" title="Descargar JSON">üì• JSON Export</div>
            <div class="draggable" draggable="true" data-type="file_download" title="Descargar archivo">üíæ File Download
            </div>
          </div>
        </details>
      </div>


    </aside>

    <section id="canvasSection" aria-label="Canvas de dise√±o">
      <h2>Canvas</h2>
      <section id="canvas" aria-label="Canvas de dise√±o">
        <div id="canvasInner"></div>
      </section>
    </section>

    <aside id="properties" aria-label="Panel de propiedades">
      <h2>Propiedades</h2>

      <output id="noSelection" aria-live="polite">Selecciona un nodo en el canvas para editar sus propiedades.</output>
      <form id="propForm" style="display:none;">
        <div class="form-row">
          <label for="prop_id">ID nodo</label>
          <input type="text" id="prop_id" required />
        </div>
        <div class="form-row">
          <label for="prop_type">Tipo</label>
          <input type="text" id="prop_type" disabled />
        </div>
        <div id="dynamicProps"></div>
        <div class="form-row">
          <label for="variablesList">Variables detectadas en el flujo</label>
          <div id="variablesList">(sin variables definidas)</div>
        </div>

        <div class="form-row actions flex gap-2 mt-4">
          <button type="submit"
            class="px-4 py-2 bg-green-600 text-white rounded shadow hover:bg-green-700 transition font-semibold text-sm">Aplicar</button>
          <button type="button" id="btnDeleteNode"
            class="px-4 py-2 bg-red-500 text-white rounded shadow hover:bg-red-600 transition font-semibold text-sm">Eliminar
            nodo</button>
        </div>
      </form>
    </aside>
  </main>


  <div id="simulatorPanel" class="simulator-panel border rounded p-2 bg-white">
    <div id="simulatorTimeline" class="sim-timeline h-40 overflow-auto" style="min-height:120px;">Registro de ejecuci√≥n
      del simulador</div>
    <div id="simulatorCanvasPreview" class="sim-canvas-preview mt-2 h-48 border rounded p-2 bg-gray-50"
      style="min-height:160px; margin-top:8px;">Vista previa del flujo (nodos visitados, variables, respuestas)</div>
    <div class="mt-2 flex items-center gap-2">
      <input id="simExtraInput" class="border rounded px-2 py-1 flex-1"
        placeholder='JSON extra por paso (ej: {"userId":42})' type="text" value="hola" />
      <button id="simExtraClear" class="px-2 py-1 bg-white border rounded text-sm"
        title="Limpiar JSON extra">Limpiar</button>
    </div>
    <div class="mt-2 flex items-center gap-2">
      <label for="simTurnSelect" class="text-xs text-gray-600">turn</label>
      <select id="simTurnSelect" class="border rounded px-2 py-1 text-sm">
        <option value="">(no inyectar)</option>
        <option value="user">user</option>
        <option value="assistant">assistant</option>
      </select>
      <button id="simTurnClear" class="px-2 py-1 bg-white border rounded text-sm" title="Limpiar turn">Limpiar</button>
    </div>
    <div class="mt-2 flex items-center gap-2">
      <input id="simOriginInput" class="border rounded px-2 py-1 flex-1"
        placeholder='origin (JSON) ej: {"role":"user","value":"hola","node":"n1"}' type="text" />
      <button id="simOriginClear" class="px-2 py-1 bg-white border rounded text-sm"
        title="Limpiar origin">Limpiar</button>
    </div>
    <div class="text-xs text-gray-500 mt-1">El campo extra es ef√≠mero por paso. Si quieres conservarlo, as√≠gnalo a una
      variable con un nodo AssignVar.</div>
    <div class="text-xs text-gray-500">Los campos turn y origin tambi√©n son ef√≠meros por paso; se limpian
      autom√°ticamente tras cada paso.</div>
  </div>
  </section>
  <section id="jsonOutSection">
    <h2>JSON generado</h2>
    <pre id="jsonOutput">{ }</pre>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/jsplumb@2.15.6/dist/js/jsplumb.min.js"></script>
  <script src="js/formbuilder.js"></script>
  <script src="js/renderers/common.js"></script>
  <script src="js/renderers/validation.js"></script>
  <script src="js/renderers/button.js"></script>
  <script src="js/renderers/multi_button_panel.js"></script>
  <script src="js/renderers/rest_call.js"></script>
  <script src="js/renderers/foreach.js"></script>
  <script src="js/renderers/while.js"></script>
  <script src="js/renderers/loop.js"></script>
  <script src="js/renderers/response.js"></script>
  <script src="js/renderers/input.js"></script>
  <script src="js/renderers/extra.js?v=20251101"></script>
  <script src="js/renderers/choice.js"></script>
  <script src="js/var_explorer.js"></script>
  <script src="js/renderers/assign_var.js"></script>
  <script src="js/renderers/condition.js"></script>
  <script src="js/renderers/flow_jump.js"></script>
  <script src="js/renderers/start.js"></script>
  <script src="js/renderers/hero_card.js"></script>
  <script src="js/renderers/carousel.js"></script>
  <script src="js/renderers/form_v2.js"></script>
  <script src="js/renderers/file_upload.js"></script>
  <script src="js/renderers/json_upload.js"></script>
  <script src="js/renderers/json_export.js"></script>
  <script src="js/renderers/file_download.js"></script>
  <script src="js/renderers/end.js"></script>
  <script src="js/renderers/hidden_response.js"></script>
  <script src="js/renderer_agent_call.js"></script>
  <script src="js/renderer_use_profile.js"></script>
  <script src="js/renderer_credential_profile.js"></script>
  <script src="js/form_renderers.js"></script>
  <script src="js/connections.js"></script>
  <script src="js/variables.js"></script>
  <script src="js/node_renderer.js"></script>
  <script src="js/node_editor.js"></script>
  <script src="js/toasts.js"></script>
  <script src="js/ui_controls.js"></script>
  <script src="js/compact_mode.js"></script>
  <script src="js/app_helpers.js"></script>
  <script src="js/ui_state.js"></script>
  <script src="js/selection_manager.js"></script>
  <script src="js/canvas_selection.js"></script>
  <script src="js/canvas_drag.js"></script>
  <script src="js/history_manager.js"></script>
  <script src="js/node_search.js"></script>
  <script src="js/keyboard_controls.js"></script>
  <script src="js/serializer.js"></script>
  <script src="js/io.js"></script>
  <script src="js/node_factory.js"></script>
  <script src="js/canvas_manager.js"></script>
  <script src="js/flow_importer.js"></script>
  <script src="js/flow_manager.js"></script>
  <!-- AI Copilot Scripts (must load before main.js) -->
  <script src="js/main.js"></script>
  <script src="js/project_flows.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/lib/marked.umd.js"></script>
  <script src="js/expression_parser.js"></script>
  <script src="js/flow_ui.js"></script>
  <script src="js/flow_runner.js"></script>
  <script src="js/runtime_demo.js"></script>
  <script src="js/simulador-evaluator.js"></script>
  <script src="js/simulador-nodes.js"></script>
  <script src="js/simulador-agents.js"></script>
  <script src="js/nodes/processResponse.js"></script>
  <script src="js/nodes/processHiddenResponse.js"></script>
  <script src="js/nodes/processEnd.js"></script>
  <script src="js/nodes/processInput.js"></script>
  <script src="js/nodes/processChoice.js"></script>
  <script src="js/nodes/processButton.js"></script>
  <script src="js/nodes/processMultiButton.js"></script>
  <script src="js/nodes/processForm.js?v=20251129"></script>
  <script src="js/simulador.js"></script>
  <script src="js/sim_profiles.js"></script>

  <script src="js/renderer_usage_report.js"></script>
  <script src="js/template_selftest.js"></script>
  <script src="js/json_modal.js"></script>
  <script>
    // Wire center canvas button
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('btnCenterCanvas');
      btn?.addEventListener('click', () => {
        try {
          // Asegura que el canvas crezca antes de centrar y ajusta zoom para encuadrar
          globalThis.App?.autoGrowCanvas?.();
          globalThis.App?.fitCanvasToContent?.(80, true);
        } catch (e) { console.warn('[UI] fitCanvasToContent failed', e); }
      });
    });
  </script>
  <script>
    // Wire simulator and AI assist modal buttons
    document.addEventListener('DOMContentLoaded', () => {
      // Simulator modal
      const btnOpenSim = document.getElementById('btnOpenSimulatorModal');
      const simModal = document.getElementById('simulatorModal');
      const btnCloseSim = document.getElementById('simulatorModalClose');

      if (btnOpenSim && simModal) {
        btnOpenSim.addEventListener('click', () => {
          simModal.classList.remove('hidden');
          simModal.classList.add('flex');
          console.log('[UI] Simulator modal opened');

          // Auto-load and start the flow
          setTimeout(() => {
            try {
              if (!window.Simulador) {
                console.warn('[UI] Simulador not initialized');
                return;
              }

              // Load flow from editor
              if (window.Simulador.flow && typeof window.Simulador.flow.loadFlowFromEditor === 'function') {
                const flow = window.Simulador.flow.loadFlowFromEditor();
                console.log('[UI] Flow loaded:', flow?.name || flow?.flow_id);

                // Initialize state
                if (window.Simulador.state && typeof window.Simulador.state.init === 'function') {
                  window.Simulador.state.init(flow);
                  console.log('[UI] State initialized');
                }

                // Start engine
                if (window.Simulador.engine && typeof window.Simulador.engine.start === 'function') {
                  window.Simulador.engine.start();
                  console.log('[UI] Engine started');
                } else {
                  console.warn('[UI] Engine not available');
                }
              } else {
                console.warn('[UI] Flow loader not available');
              }
            } catch (e) {
              console.error('[UI] Failed to start simulator:', e);
              if (window.Simulador?.ui?.log) {
                window.Simulador.ui.log('Error al iniciar: ' + e.message);
              }
            }
          }, 100);
        });
      }
      if (btnCloseSim && simModal) {
        btnCloseSim.addEventListener('click', () => {
          simModal.classList.add('hidden');
          simModal.classList.remove('flex');
          console.log('[UI] Simulator modal closed');
        });
      }
    });
  </script>
  <script>
    // Auto-loader para pruebas r√°pidas: ?autotest=1 carga tests/form_test.json y abre el simulador
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const params = new URLSearchParams(location.search);
        if (!params.has('autotest')) return;
        const res = await fetch('tests/form_test.json', { cache: 'no-store' });
        if (!res.ok) { console.warn('[AutoTest] fetch fall√≥', res.status); return; }
        const data = await res.json();
        // Importar flujo en el editor
        if (window.App && typeof window.App.importJson === 'function') {
          try { window.App.importJson(data); } catch (e) { console.warn('[AutoTest] importJson fall√≥', e); }
        }
        // Marcar flow_id activo si existe soporte de proyecto
        try {
          window.AppProject = window.AppProject || {}; window.AppProject.flows = window.AppProject.flows || {};
          if (data.flow_id) {
            window.AppProject.flows[data.flow_id] = { meta: { name: data.name || data.flow_id, start_node: data.start_node }, nodes: data.nodes };
            window.AppProject.active_flow_id = data.flow_id;
          }
        } catch (_) { }
        // Abrir simulador
        setTimeout(() => {
          const btn = document.getElementById('btnOpenSimulatorModal');
          if (btn) btn.click();
        }, 400);
      } catch (e) {
        console.warn('[AutoTest] error', e);
      }
    });
  </script>

  <!-- Modal Flujos -->
  <div id="flowsModal" class="fixed inset-0 z-[360] hidden items-center justify-center bg-black bg-opacity-40"
    aria-hidden="true" role="dialog" aria-modal="true" tabindex="-1">
    <div class="w-full max-w-2xl bg-white rounded-lg shadow-lg overflow-hidden flex flex-col max-h-[80vh]">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-lg font-semibold">Flujos del proyecto</h3>
        <button id="flowsModalClose" class="text-gray-600 hover:text-gray-900">‚úï</button>
      </div>
      <div class="p-4 space-y-3 flex-1 overflow-y-auto">
        <div class="flex items-center gap-2">
          <button id="btnCreateFlow" class="px-3 py-2 bg-sky-600 text-white rounded text-sm">Nuevo flujo</button>
          <button id="btnUpsertCurrent" class="px-3 py-2 bg-white border rounded text-sm"
            title="Guardar/actualizar el flujo abierto en el proyecto">A√±adir/Actualizar actual</button>
          <button id="btnImportFolder" class="px-3 py-2 bg-white border rounded text-sm"
            title="Importar todos los .json de una carpeta">Abrir carpeta</button>
        </div>
        <div id="flowsList" class="divide-y border rounded"></div>
      </div>
      <div class="p-3 border-t text-xs text-gray-500">
        Consejo: marca un flujo como Principal para exportarlo por defecto.
      </div>
    </div>
  </div>
  <!-- Modal de Ayuda extra√≠do: se carga desde components/help_modal.html por js/help_modal.js -->
  <script src="js/help_modal.js"></script>
  <script src="js/template_loader.js"></script>
  <!-- JSON modal -->

  <style>
    /* Backdrop y layout para dialog de ayuda */
    #helpModal::backdrop {
      background: rgba(0, 0, 0, 0.4);
    }

    /* Layout modal simulator: left debug 40% / right chat 60%; responsive stack on small screens */
    .simulator-grid {
      display: grid;
      grid-template-columns: 40% 60%;
      gap: 0;
      height: calc(90vh - 56px);
    }

    @media (max-width: 768px) {
      .simulator-grid {
        grid-template-columns: 1fr;
        height: auto;
      }

      .simulator-grid aside {
        order: -1;
      }
    }

    /* Ensure pre elements in debug are readable */
    #simulatorDebugPanel pre {
      color: #111827;
      background: #ffffff;
    }
  </style>

  <div id="jsonModal" class="modal-overlay" style="display:none" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-header">
        <h3>JSON generado</h3>
        <button id="jsonModalClose" class="modal-close">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="modal-actions">
          <button id="jsonModalCopy" class="px-3 py-1 bg-sky-600 text-white rounded text-sm">Copiar</button>
          <button id="jsonModalEdit" class="px-3 py-1 bg-white border rounded text-sm">Editar</button>
          <button id="jsonModalSave" class="px-3 py-1 bg-green-600 text-white rounded text-sm"
            style="display:none">Guardar</button>
          <button id="jsonModalCancel" class="px-3 py-1 bg-white border rounded text-sm"
            style="display:none">Cancelar</button>
          <button id="jsonModalFormat" class="px-3 py-1 bg-white border rounded text-sm"
            style="display:none">Formatear</button>
          <button id="jsonModalValidate" class="px-3 py-1 bg-white border rounded text-sm"
            style="display:none">Validar</button>
        </div>
        <pre id="jsonModalContent" class="json-content">{ }</pre>
        <textarea id="jsonModalEditor" class="json-editor"
          style="display:none; width:100%; min-height:50vh; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px; line-height:1.4; border:1px solid #e5e7eb; border-radius:6px; padding:8px; background:#ffffff;"></textarea>
        <div id="jsonModalWarnings" class="mt-2 text-xs" style="display:none"></div>
      </div>
    </div>
  </div>
  <!-- Simulador Modal (chat) -->
  <div id="simulatorModal" class="fixed inset-0 z-[300] hidden items-center justify-center bg-black bg-opacity-40"
    aria-hidden="true">
    <div class="w-full max-w-6xl h-[90vh] bg-white rounded-lg shadow-lg flex flex-col overflow-hidden">
      <!-- Modal header -->
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-lg font-semibold flex items-center gap-3">
          Simulador ‚Äî Chat
          <span id="simProfileChip" class="hidden items-center gap-1 px-2 py-0.5 rounded-full text-xs border">
            <span aria-hidden="true">üîê</span>
            <span class="sp-name">(sin perfil)</span>
            <span class="sp-status text-[10px] opacity-70"></span>
          </span>
        </h3>
        <div class="flex items-center gap-2">
          <button id="btnProfilesManager" class="px-3 py-1 bg-white border rounded text-sm"
            title="Gestionar perfiles del simulador">Perfiles</button>

          <button id="btnSimulatorSettings" class="px-3 py-1 bg-white border rounded text-sm"
            title="Configurar backend del simulador">Configuraci√≥n</button>

          <button id="btnShowHelp" class="px-3 py-1 bg-white border rounded text-sm" title="Mostrar ayuda">?</button>
          <button id="simulatorModalClose" class="text-gray-600 hover:text-gray-900">‚úï</button>
        </div>
      </div>

      <!-- Modal body: grid 40/60 -->
      <div class="modal-body flex-1 overflow-hidden p-4">
        <div class="simulator-grid h-full">
          <!-- Left: debug panel (40%) -->
          <aside id="simulatorDebugPanel" aria-label="Panel de depuraci√≥n del simulador"
            class="border-r bg-gray-50 p-4 flex flex-col gap-4 overflow-auto text-xs">
            <div id="simulatorWarnings" class="hidden p-2 rounded border border-amber-300 bg-amber-50 text-amber-800">
            </div>

            <!-- Controls Container (Event Trigger, etc.) -->
            <div id="simulatorControls" class="mb-2"></div>

            <div>
              <h4 class="font-semibold mb-1 text-sm">Flow JSON</h4>
              <pre id="debugFlowJson"
                class="text-[11px] leading-snug bg-white border rounded p-2 max-h-40 overflow-auto">{}</pre>
            </div>
            <div>
              <h4 class="font-semibold mb-1 text-sm">Nodo actual</h4>
              <pre id="debugCurrentNode"
                class="text-[11px] leading-snug bg-white border rounded p-2 max-h-40 overflow-auto">{}</pre>
            </div>
            <div>
              <h4 class="font-semibold mb-1 text-sm">Variables</h4>
              <pre id="debugVariables"
                class="text-[11px] leading-snug bg-white border rounded p-2 max-h-40 overflow-auto">{}</pre>
            </div>
            <div>
              <h4 class="font-semibold mb-1 text-sm">Call stack</h4>
              <pre id="debugCallStack"
                class="text-[11px] leading-snug bg-white border rounded p-2 max-h-40 overflow-auto">(vac√≠a)</pre>
            </div>
            <div>
              <h4 class="font-semibold mb-1 text-sm">Diff variables</h4>
              <pre id="debugVarDiff"
                class="text-[11px] leading-snug bg-white border rounded p-2 max-h-40 overflow-auto">(sin cambios)</pre>
            </div>
            <div>
              <h4 class="font-semibold mb-1 text-sm">Editar variables</h4>
              <div id="simulatorVarsList" class="space-y-2 overflow-auto bg-white border rounded p-2"
                style="max-height:28vh"></div>
            </div>
            <div class="mt-auto">
              <button id="btnVarsSave" class="w-full mb-2 px-3 py-2 bg-sky-600 text-white rounded text-sm">Guardar
                variables</button>
              <button id="btnVarsReset" class="w-full px-3 py-2 bg-white border rounded text-sm">Reset
                variables</button>
            </div>
          </aside>

          <!-- Right: chat (60%) -->
          <div class="flex-1 flex flex-col overflow-hidden bg-white">
            <div class="p-4 border-b bg-gray-50">
              <h4 class="font-semibold">Chat del simulador</h4>
            </div>
            <div id="simulatorChat" class="p-4 flex-1 overflow-auto bg-gray-50"></div>
            <div class="p-4 border-t bg-white flex gap-2 items-center">
              <input id="simulatorInputBox" type="text" placeholder="Escribe tu respuesta..."
                class="flex-1 px-3 py-2 border rounded-md" />
              <button id="simulatorSendBtn" class="px-4 py-2 bg-sky-600 text-white rounded">Enviar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- AI Copilot Container (Loaded dynamically) -->
  <div id="copilotContainer"></div>

  <!-- AI Copilot Scripts (must load before main.js) -->
  <script src="js/copilot/local.js"></script>
  <script src="js/copilot/core.js"></script>
  <script src="js/copilot/ui.js"></script>
  <script src="js/copilot/azure.js"></script>
  <script src="js/copilot/ollama.js"></script>

  <!-- Initialization -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Init Copilot if available
      if (window.CopilotCore) {
        CopilotCore.init({
          provider: localStorage.getItem('bri_cp_provider') || 'azure',
          azureEndpoint: localStorage.getItem('bri_azure_endpoint'),
          azureKey: localStorage.getItem('bri_azure_key'),
          azureModel: localStorage.getItem('bri_azure_model'),
          ollamaEndpoint: localStorage.getItem('bri_ollama_endpoint'),
          ollamaModel: localStorage.getItem('bri_ollama_model')
        });
        console.log('[HTML] Copilot initialized successfully');
      } else {
        console.warn('[HTML] CopilotCore not found');
      }
    });
  </script>

</body>

</html>